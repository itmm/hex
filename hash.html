<!doctype html>
<html lang="de"l>
<head>
<meta charset="utf-8">
<title>Schnelle Hash-Funktion</title><link rel="stylesheet" type="text/css" href="slides/slides.css"></head>
<body>
<h1>Schnelle Hash-Funktion</h1>
<div class="slides">
<div><div>
<h1>Schnelle Hash-Funktion</h1>
</div>

<ul><li>
 Nicht super sicher
</li><li>
 Nicht super toll
</li><li>
 Aber schnell
</li></ul></div>

<div><div>
<code>

<span class="add">@globadd(<span class="name">global elements</span>)</span><br/>

<span class="in1"></span><span class="expand">@expand(<span class="name">define hash</span>)</span>;<br/>

<span class="end">@end(<span class="name">global elements</span>)</span><br/>

</code>
</div>

<ul><li>
 Hash-Berechnung ist eine global sichtbare Funktion
</li></ul></div>

<div><div>
<code>

<span class="add">@def(<span class="name">define hash</span>)</span><br/>

<span class="in1"></span><span class="var">class</span> <span class="type">Hash</span> {<br/>

<span class="in2"></span><span class="var">private</span>:<br/>

<span class="in3"></span><span class="type">unsigned</span> <span class="var">_hash</span>;<br/>

<span class="in2"></span><span class="var">public</span>:<br/>

<span class="in3"></span><span class="expand">@expand(<span class="name">functions</span>)</span>;<br/>

<span class="in1"></span>};<br/>

<span class="end">@end(<span class="name">define hash</span>)</span><br/>

</code>
</div>

<ul><li>
 Der Hash wird Zeichen für Zeichen berechnet und im Attribut <code>_hash</code>
  abgelegt
</li></ul></div>

<div><div>
<code>

<span class="add">@def(<span class="name">functions</span>)</span><br/>

<span class="in1"></span><span class="fn">Hash</span>(): <span class="fn">_hash</span>(<span class="num">0x3d9a73b5</span>) {}<br/>

<span class="end">@end(<span class="name">functions</span>)</span><br/>

</code>
</div>

<ul><li>
 Um deterministisch zu sein, werden Hashes mit einer festen Zahl
  initialisiert
</li><li>
 Diese Zahl wurde zufällig gewählt
</li></ul></div>

<div><div>
<code>

<span class="add">@add(<span class="name">functions</span>)</span><br/>

<span class="in1"></span><span class="type">int</span> <span class="fn">hash</span>() <span class="type">const</span> {<br/>

<span class="in2"></span><span class="keyword">return</span> <span class="var">static_cast</span>&lt;<span class="type">int</span>&gt;(<br/>

<span class="in3"></span><span class="var">_hash</span> &amp; <span class="num">0x7fffffff</span><br/>

<span class="in2"></span>);<br/>

<span class="in1"></span>}<br/>

<span class="end">@end(<span class="name">functions</span>)</span><br/>

</code>
</div>

<ul><li>
 Nach außen wird das oberste Bit maskiert
</li><li>
 So kann es als <code>int</code> verwendet werden
</li><li>
 Wird aber nie negativ
</li></ul></div>

<div><div>
<code>

<span class="add">@add(<span class="name">functions</span>)</span><br/>

<span class="in1"></span><span class="type">unsigned</span> <span class="fn">add</span>(<span class="type">const</span> <span class="var">std</span>::<span class="var">string</span> &amp;<span class="var">s</span>);<br/>

<span class="end">@end(<span class="name">functions</span>)</span><br/>

</code>
</div>

<ul><li>
 Die <code>f{add}</code>-Methode aktualisiert den Hash mit den Zeichen von
  <code>s</code>
</li><li>
 Diese Methode ist nicht <code>inline</code> implementiert
</li></ul></div>

</div>
<h1>Hash berechnen</h1>
<div class="slides">
<div><div>
<h1>Hash berechnen</h1>
</div>

<ul><li>
 Beschreibt die <code>f{add}</code>-Methode
</li></ul></div>

<div><div>
<code>

<span class="add">@add(<span class="name">define hash</span>)</span><br/>

<span class="in1"></span><span class="type">unsigned</span> <span class="type">Hash</span>::<span class="fn">add</span>(<br/>

<span class="in2"></span><span class="type">const</span> <span class="var">std</span>::<span class="var">string</span> &amp;<span class="var">s</span><br/>

<span class="in1"></span>) {<br/>

<span class="in2"></span><span class="keyword">for</span> (<span class="var">auto</span> &amp;<span class="var">ch</span> : <span class="var">s</span>) {<br/>

<span class="in3"></span><span class="expand">@expand(<span class="name">hash next ch</span>)</span>;<br/>

<span class="in2"></span>}<br/>

<span class="in2"></span><span class="keyword">return</span> <span class="fn">hash</span>();<br/>

<span class="in1"></span>}<br/>

<span class="end">@end(<span class="name">define hash</span>)</span><br/>

</code>
</div>

<ul><li>
 Die <code>f{add}</code>-Methode iteriert über jedes Zeichen
</li><li>
 Und fügt es dem Hash hinzu
</li><li>
 Das maskierte Ergebnis wird zurück geliefert
</li></ul></div>

<div><div>
<code>

<span class="add">@def(<span class="name">hash next ch</span>)</span><br/>

<span class="in1"></span><span class="var">_hash</span> ^= <span class="var">ch</span>;<br/>

<span class="end">@end(<span class="name">hash next ch</span>)</span><br/>

</code>
</div>

<ul><li>
 Zuerst wird das aktuelle Zeichen per XOR mit dem aktuellen Hash
  verknüpft
</li></ul></div>

<div><div>
<code>

<span class="add">@add(<span class="name">hash next ch</span>)</span><br/>

<span class="in1"></span><span class="var">_hash</span> = (<span class="var">_hash</span> &lt;&lt; <span class="num">3</span>) | (<span class="var">_hash</span> &gt;&gt; <span class="num">29</span>);<br/>

<span class="end">@end(<span class="name">hash next ch</span>)</span><br/>

</code>
</div>

<ul><li>
 Danach wird der Hash um 3 Bit rotiert
</li><li>
 Und das war es schon
</li></ul></div>

<div><div>
<code>

<span class="add">@add(<span class="name">define hash</span>)</span><br/>

<span class="in1"></span><span class="type">int</span> <span class="fn">calcHash</span>(<br/>

<span class="in2"></span><span class="type">const</span> <span class="type">char</span> *<span class="var">begin</span>,<br/>

<span class="in2"></span><span class="type">const</span> <span class="type">char</span> *<span class="var">end</span><br/>

<span class="in1"></span>) {<br/>

<span class="in2"></span><span class="type">Hash</span> <span class="var">h</span>;<br/>

<span class="in2"></span><span class="keyword">return</span> <span class="var">h</span>.<span class="fn">add</span>(<br/>

<span class="in3"></span><span class="var">std</span>::<span class="fn">string</span>(<span class="var">begin</span>, <span class="var">end</span>)<br/>

<span class="in2"></span>);<br/>

<span class="in1"></span>}<br/>

<span class="end">@end(<span class="name">define hash</span>)</span><br/>

</code>
</div>

<ul><li>
 Berechnet den Hash über einen festen Zeichenbereich
</li><li>
 Sobald <code>frag.x</code> nicht mehr selber hasht, kann diese Funktion raus
</li></ul></div>

