<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Description of the `Frag` `class`</title>
<link rel="stylesheet" type="text/css" href="slides/slides.css"></head>
<body>
<h1>Description of the <code><span class="type">Frag</span></code> <code><span class="keyword">class</span></code></h1>
<div class="slides">
<div>
<div>
<h1>Description of the <code><span class="type">Frag</span></code> <code><span class="keyword">class</span></code></h1>
</div>
<ul><li>
<code><span class="type">Frag</span></code>s form a directed acyclic graph (<code><span class="var">DAG</span></code>)
</li><li>
the infix traversal of this <code><span class="var">DAG</span></code> generates the source code files
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">input prereqs</span>)</span><br/>
<span class="in1"></span><span class="keyword">class</span> <span class="type">Frag</span>;<br/>
<br/>
<span class="in1"></span><span class="type">struct</span> <span class="type">Write_State</span> {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="type">string</span> <span class="var">source_name</span> = {};<br/>
<span class="in2"></span><span class="type">bool</span> <span class="var">in_macro</span> = <span class="num">false</span>;<br/>
<span class="in2"></span><span class="type">bool</span> <span class="var">c_style</span>;<br/>
<br/>
<span class="in2"></span><span class="fn">Write_State</span>(<span class="type">const</span> <span class="type">Frag</span> &amp;<span class="var">f</span>);<br/>
<span class="in1"></span>};<br/>
<span class="macro">@End(<span class="name">input prereqs</span>)</span><br/>
</code></div>
<ul><li>
the <code><span class="type">Write_State</span></code> <code><span class="keyword">class</span></code> is important for writing line macros in  C-like files
</li><li>
the lines must only be written in C-like files
</li><li>
and only if the current output is not in a C-like macro definition
</li><li>
the state is initialized later from a <code><span class="type">Frag</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">input prereqs</span>)</span><br/>
<span class="in1"></span><span class="macro">@Put(<span class="name">frag prereqs</span>)</span>;<br/>
<span class="in1"></span><span class="macro">@put(<span class="name">define frag</span>)</span>;<br/>
<span class="macro">@end(<span class="name">input prereqs</span>)</span><br/>
</code></div>
<ul><li>
<code><span class="type">Frag</span></code>s are global elements
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">define frag</span>)</span><br/>
<span class="in1"></span><span class="keyword">class</span> <span class="type">Frag_Ref</span> {<br/>
<span class="in1"></span><span class="keyword">public</span>:<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> <span class="var">path</span>;<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> <span class="var">name</span>;<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">bool</span> <span class="var">local</span>;<br/>
<span class="in2"></span><span class="fn">Frag_Ref</span>(<br/>
<span class="in3"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">p</span>,<br/>
<span class="in3"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">n</span>,<br/>
<span class="in3"></span><span class="type">bool</span> <span class="var">l</span><br/>
<span class="in2"></span>):<br/>
<span class="in3"></span><span class="var">path</span> { <span class="var">p</span> },<br/>
<span class="in3"></span><span class="var">name</span> { <span class="var">n</span> },<br/>
<span class="in3"></span><span class="var">local</span> { <span class="var">l</span> }<br/>
<span class="in2"></span>{ }<br/>
<span class="in1"></span>};<br/>
<span class="in1"></span><span class="keyword">class</span> <span class="type">Frag_Entry</span> {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="type">string</span> <span class="var">_str</span>;<br/>
<span class="in2"></span><span class="type">std</span>::<span class="type">string</span> <span class="var">_file</span>;<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">_first_line</span> = -<span class="num">1</span>;<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">_last_line</span>;<br/>
<span class="in2"></span><span class="type">Frag_Ref</span> <span class="var">_sub</span> = { <span class="type">std</span>::<span class="type">string</span> { }, <span class="type">std</span>::<span class="type">string</span> { }, <span class="num">true</span> };<br/>
<span class="in1"></span><span class="keyword">public</span>:<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">entry methods</span>)</span>;<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Frag_Ref</span> &amp;<span class="fn">sub</span>() <span class="type">const</span> {<br/>
<span class="in3"></span><span class="keyword">return</span> <span class="var">_sub</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>};<br/>
<span class="macro">@end(<span class="name">define frag</span>)</span><br/>
</code></div>
<ul><li>
a <code><span class="type">Frag</span></code> contains a collection of entries
</li><li>
each entry describes a range in the input file marked by <code><span class="var">_file</span></code>,  <code><span class="var">_first_line</span></code> and <code><span class="var">_last_line</span></code>
</li><li>
each entry contains a string value or a reference to another <code><span class="type">Frag</span></code>
</li><li>
if both are available the <code><span class="type">Frag</span></code> expands the referenced <code><span class="var">frag</span></code> before  the <code><span class="var">_str</span></code>
</li><li>
so a <code><span class="var">_frag</span></code> can easily concatenate bytes to the <code><span class="var">_str</span></code> of its last  entry
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">entry methods</span>)</span><br/>
<span class="in1"></span><span class="fn">Frag_Entry</span>() { }<br/>
<span class="in1"></span><span class="fn">Frag_Entry</span>(<span class="type">Frag_Ref</span> <span class="var">sub</span>):<br/>
<span class="in2"></span><span class="var">_sub</span> { <span class="var">sub</span> }<br/>
<span class="in1"></span>{ }<br/>
<span class="macro">@end(<span class="name">entry methods</span>)</span><br/>
</code></div>
<ul><li>
an entry can be initialized with a sub <code><span class="type">Frag</span></code>
</li><li>
no range is provided in this case
</li><li>
the range information of the sub <code><span class="type">Frag</span></code> will be used
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">entry methods</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">update_state</span>(<br/>
<span class="in2"></span><span class="type">Write_State</span> &amp;<span class="var">state</span><br/>
<span class="in1"></span>) <span class="type">const</span> {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">update state</span>)</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">entry methods</span>)</span><br/>
</code></div>
<ul><li>
this method checks, if the input is in a multi-line macro definition
</li><li>
that is the case, if the line ends with a backslash followed by  newline characters
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">update state</span>)</span><br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">c</span> { <span class="var">_str</span>.<span class="fn">end</span>() };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">b</span> { <span class="var">_str</span>.<span class="fn">begin</span>() };<br/>
<span class="in1"></span><span class="type">bool</span> <span class="var">some_nl</span> { <span class="num">false</span> };<br/>
<span class="in1"></span><span class="keyword">while</span> (<span class="var">b</span> != <span class="var">c</span>) {<br/>
<span class="in2"></span>--<span class="var">c</span>;<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">update state checks</span>)</span>;<br/>
<span class="in2"></span><span class="keyword">break</span>;<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">b</span> != <span class="var">c</span> &amp;&amp; *<span class="var">c</span> &gt; <span class="str">' '</span>) {<br/>
<span class="in2"></span><span class="var">state</span>.<span class="var">in_macro</span> = <span class="num">false</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">update state</span>)</span><br/>
</code></div>
<ul><li>
if some characters are found in the line, it is not in a macro, if  it was not recognized in the loop
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">update state checks</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (*<span class="var">c</span> == <span class="str">'\n'</span> || *<span class="var">c</span> == <span class="str">'\r'</span>) {<br/>
<span class="in2"></span><span class="var">some_nl</span> = <span class="num">true</span>;<br/>
<span class="in2"></span><span class="keyword">continue</span>;<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="keyword">if</span> (*<span class="var">c</span> &lt;= <span class="str">' '</span>) { <span class="keyword">continue</span>; }<br/>
<span class="in1"></span><span class="keyword">if</span> (*<span class="var">c</span> == <span class="str">'\\'</span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">some_nl</span>) {<br/>
<span class="in3"></span><span class="var">state</span>.<span class="var">in_macro</span> = <span class="num">true</span>;<br/>
<span class="in3"></span><span class="keyword">return</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">update state checks</span>)</span><br/>
</code></div>
<ul><li>
this method checks, if the input is in a multi-line macro definition
</li><li>
that is the case, if the line ends with a backslash followed by  newline characters
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">entry methods</span>)</span><br/>
<span class="in1"></span><span class="type">std</span>::<span class="type">string</span> <span class="fn">str</span>(<br/>
<span class="in2"></span><span class="type">Write_State</span> &amp;<span class="var">state</span><br/>
<span class="in1"></span>) <span class="type">const</span> {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">check c-like</span>)</span>;<br/>
<span class="in2"></span><span class="type">std</span>::<span class="var">ostringstream</span> <span class="var">oss</span>;<br/>
<span class="in2"></span><span class="var">oss</span> &lt;&lt; <span class="str">"\n#line "</span> &lt;&lt;<br/>
<span class="in3"></span><span class="var">_first_line</span> &lt;&lt; <span class="str">" \""</span> &lt;&lt;<br/>
<span class="in3"></span><span class="var">_file</span> &lt;&lt; <span class="str">"\"\n"</span> &lt;&lt; <span class="var">_str</span>;<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">oss</span>.<span class="fn">str</span>();<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">entry methods</span>)</span><br/>
</code></div>
<ul><li>
generates an output line
</li><li>
if the current source file is C-like, a <code><span class="keyword">#line</span></code> macro is written before  the content
</li><li>
so that a C compiler refers warnings and errors to the position in the  input file
</li><li>
not in the generated source file
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">check c-like</span>)</span><br/>
<span class="in1"></span><span class="type">bool</span> <span class="var">old</span> { <span class="var">state</span>.<span class="var">in_macro</span> };<br/>
<span class="in1"></span><span class="fn">update_state</span>(<span class="var">state</span>);<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">old</span>) { <span class="keyword">return</span> <span class="var">_str</span>; }<br/>
<span class="in1"></span><span class="keyword">if</span> (! <span class="var">state</span>.<span class="var">c_style</span>) { <span class="keyword">return</span> <span class="var">_str</span>; }<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">_first_line</span> &lt; <span class="num">1</span>) { <span class="keyword">return</span> <span class="var">_str</span>; }<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">_str</span>.<span class="fn">empty</span>()) { <span class="keyword">return</span> <span class="var">_str</span>; };<br/>
<span class="macro">@end(<span class="name">check c-like</span>)</span><br/>
</code></div>
<ul><li>
C-like macros are not added, if the current line is part of a  multi-line macro
</li><li>
or if the file does not support line-macros
</li><li>
or the line is not set
</li><li>
or the string is empty
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">entry methods</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">add</span>(<br/>
<span class="in2"></span><span class="type">char</span> <span class="var">ch</span>, <span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">file</span>,<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">line</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@mul(<span class="name">copy file and line</span>)</span>;<br/>
<span class="in2"></span><span class="var">_str</span> += <span class="var">ch</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">entry methods</span>)</span><br/>
</code></div>
<ul><li>
adds a character to an entry
</li><li>
also the range of the entry is updated
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">copy file and line</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<br/>
<span class="in2"></span><span class="var">_file</span>.<span class="fn">empty</span>() || <span class="var">_first_line</span> &lt;= <span class="num">0</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="var">_file</span> = <span class="var">file</span>;<br/>
<span class="in2"></span><span class="var">_first_line</span> = <span class="var">line</span>;<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="var">_last_line</span> = <span class="var">line</span>;<br/>
<span class="macro">@end(<span class="name">copy file and line</span>)</span><br/>
</code></div>
<ul><li>
if the entry is empty, the beginning of the range is updated
</li><li>
also the end of the range is updated
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">entry methods</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">add</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">value</span>,<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">file</span>,<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">line</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@mul(<span class="name">copy file and line</span>)</span>;<br/>
<span class="in2"></span><span class="var">_str</span> += <span class="var">value</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">entry methods</span>)</span><br/>
</code></div>
<ul><li>
adds a whole <code><span class="type">std</span>::<span class="type">string</span></code> to an entry
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">entry methods</span>)</span><br/>
<span class="in1"></span><span class="type">bool</span> <span class="fn">canAdd</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">file</span>,<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">line</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">can add</span>)</span>;<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="num">false</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">entry methods</span>)</span><br/>
</code></div>
<ul><li>
checks if a character at the specified position can be added to the  fragment
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">can add</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<br/>
<span class="in2"></span>! <span class="var">_file</span>.<span class="fn">empty</span>() &amp;&amp; <span class="var">file</span> != <span class="var">_file</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="num">false</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">can add</span>)</span><br/>
</code></div>
<ul><li>
if the entry has a different file name, the character can not be added  to this fragment
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">can add</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<br/>
<span class="in2"></span><span class="var">_last_line</span> &gt; <span class="num">0</span> &amp;&amp;<br/>
<span class="in2"></span><span class="var">_last_line</span> != <span class="var">line</span> &amp;&amp;<br/>
<span class="in2"></span><span class="var">_last_line</span> + <span class="num">1</span> != <span class="var">line</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="num">false</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">can add</span>)</span><br/>
</code></div>
<ul><li>
if the last line does not match to the position, the character can not  be added
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">can add</span>)</span><br/>
<span class="in1"></span><span class="keyword">return</span> <span class="num">true</span>;<br/>
<span class="macro">@end(<span class="name">can add</span>)</span><br/>
</code></div>
<ul><li>
otherwise the character can be added
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">includes</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="type">vector</span>&gt;<br/>
<span class="macro">@end(<span class="name">includes</span>)</span><br/>
</code></div>
<ul><li>
needs <code><span class="type">std</span>::<span class="type">vector</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">define frag</span>)</span><br/>
<span class="in1"></span><span class="keyword">class</span> <span class="type">Frag</span> {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="type">vector</span>&lt;<span class="type">Frag_Entry</span>&gt; <span class="var">_entries</span>;<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">_expands</span>;<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">_multiples</span>;<br/>
<span class="in2"></span><span class="type">Frag</span> *<span class="var">_prefix</span>;<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">bool</span> <span class="var">_is_meta</span>;<br/>
<span class="in1"></span><span class="keyword">public</span>:<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> <span class="var">name</span>;<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">frag methods</span>)</span>;<br/>
<span class="in1"></span>};<br/>
<span class="macro">@end(<span class="name">define frag</span>)</span><br/>
</code></div>
<ul><li>
a <code><span class="type">Frag</span></code> contains a collection of <code><span class="type">Frag_Entry</span></code>s
</li><li>
also a count is kept, how often the <code><span class="type">Frag</span></code> was expanded in single and  multiple style
</li></ul>
</div>
</div>
<h2>add a <code><span class="type">Frag</span></code></h2>
<div class="slides">
<div>
<div>
<h2>add a <code><span class="type">Frag</span></code></h2>
</div>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">frag methods</span>)</span><br/>
<span class="in1"></span><span class="keyword">static</span> <span class="type">bool</span> <span class="fn">isFile</span>(<span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">name</span>) {<br/>
<span class="in2"></span><span class="keyword">static</span> <span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> <span class="var">prefix</span> {<br/>
<span class="in3"></span><span class="str">"file: "</span><br/>
<span class="in2"></span>};<br/>
<span class="in2"></span><span class="type">std</span>::<span class="type">string</span> <span class="var">p</span> {<br/>
<span class="in3"></span><span class="var">name</span>.<span class="fn">substr</span>(<span class="num">0</span>, <span class="var">prefix</span>.<span class="fn">size</span>())<br/>
<span class="in2"></span>};<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">p</span> == <span class="var">prefix</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">frag methods</span>)</span><br/>
</code></div>
<ul><li>
a <code><span class="type">Frag</span></code> describes a file if its name has the prefix <code><span class="str">file: </span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">frag methods</span>)</span><br/>
<span class="in1"></span><span class="keyword">static</span> <span class="type">std</span>::<span class="type">string</span> <span class="fn">cmd</span>(<span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">name</span>) {<br/>
<span class="in2"></span><span class="keyword">static</span> <span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> <span class="var">prefix</span> {<br/>
<span class="in3"></span><span class="str">"| "</span><br/>
<span class="in2"></span>};<br/>
<span class="in2"></span><span class="type">std</span>::<span class="type">string</span> <span class="var">p</span> {<br/>
<span class="in3"></span><span class="var">name</span>.<span class="fn">substr</span>(<span class="num">0</span>, <span class="var">prefix</span>.<span class="fn">size</span>())<br/>
<span class="in2"></span>};<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">p</span> == <span class="var">prefix</span> ?<br/>
<span class="in3"></span><span class="var">name</span>.<span class="fn">substr</span>(<span class="var">prefix</span>.<span class="fn">size</span>()) :<br/>
<span class="in3"></span><span class="type">std</span>::<span class="type">string</span> {};<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">frag methods</span>)</span><br/>
</code></div>
<ul><li>
a <code><span class="type">Frag</span></code> describes a command if its name has the prefix <code><span class="str">| </span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">frag methods</span>)</span><br/>
<span class="in1"></span><span class="fn">Frag</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">name</span>,<br/>
<span class="in2"></span><span class="type">Frag</span> *<span class="var">prefix</span><br/>
<span class="in1"></span>):<br/>
<span class="in2"></span><span class="var">_entries</span> {},<br/>
<span class="in2"></span><span class="var">_expands</span> { <span class="num">0</span> },<br/>
<span class="in2"></span><span class="var">_multiples</span> { <span class="num">0</span> },<br/>
<span class="in2"></span><span class="var">_prefix</span> { <span class="var">prefix</span> },<br/>
<span class="in2"></span><span class="var">_is_meta</span> { <span class="var">name</span>.<span class="fn">find</span>(<span class="str">'@'</span>) != <span class="type">std</span>::<span class="type">string</span>::<span class="var">npos</span> },<br/>
<span class="in2"></span><span class="var">name</span> { <span class="var">name</span> }<br/>
<span class="in1"></span>{<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="fn">isFile</span>(<span class="var">name</span>)) { ++<span class="var">_expands</span>; }<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="fn">cmd</span>(<span class="var">name</span>).<span class="fn">size</span>()) { ++<span class="var">_expands</span>; }<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">frag methods</span>)</span><br/>
</code></div>
<ul><li>
initializes as <code><span class="type">Frag</span></code>
</li><li>
if the <code><span class="type">Frag</span></code> is a name or command, it is counted as a single expand
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">frag methods</span>)</span><br/>
<span class="in1"></span><span class="type">const</span> <span class="type">Frag</span> *<span class="fn">prefix</span>() <span class="type">const</span> {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">_prefix</span>;<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="type">Frag</span> *<span class="fn">prefix</span>() {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">_prefix</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">frag methods</span>)</span><br/>
</code></div>
<ul><li>
get prefix fragment
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">frag methods</span>)</span><br/>
<span class="in1"></span><span class="type">bool</span> <span class="fn">is_meta</span>() {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">_is_meta</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">frag methods</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">frag methods</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">clear</span>() {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">_prefix</span>) {<br/>
<span class="in3"></span><span class="var">_prefix</span>-&gt;<span class="fn">clear</span>();<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="var">_entries</span>.<span class="fn">clear</span>();<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">frag methods</span>)</span><br/>
</code></div>
<ul><li>
deletes all entries
</li><li>
will be used by <code>@<span class="var">rep</span></code> and <code>@<span class="type">Rep</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">frag methods</span>)</span><br/>
<span class="in1"></span><span class="type">bool</span> <span class="fn">empty</span>() <span class="type">const</span> {<br/>
<span class="in2"></span><span class="keyword">if</span> (<br/>
<span class="in3"></span><span class="var">_prefix</span> &amp;&amp; ! <span class="var">_prefix</span>-&gt;<span class="fn">empty</span>()<br/>
<span class="in2"></span>) {<br/>
<span class="in3"></span><span class="keyword">return</span> <span class="num">false</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">_entries</span>.<span class="fn">empty</span>();<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">frag methods</span>)</span><br/>
</code></div>
<ul><li>
a fragment is empty, if it does not have any entries
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">define frag</span>)</span><br/>
<span class="in1"></span><span class="type">Write_State</span>::<span class="fn">Write_State</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Frag</span> &amp;<span class="var">f</span><br/>
<span class="in1"></span>):<br/>
<span class="in2"></span><span class="var">c_style</span> { <span class="var">f</span>.<span class="fn">is_c_style</span>() }<br/>
<span class="in1"></span>{ }<br/>
<span class="macro">@end(<span class="name">define frag</span>)</span><br/>
</code></div>
<ul><li>
the C-like property is copied from the fragment
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Def(<span class="name">perform unit-tests</span>)</span><br/>
<span class="in1"></span><span class="macro">@put(<span class="name">unit-tests</span>)</span>;<br/>
<span class="macro">@end(<span class="name">perform unit-tests</span>)</span><br/>
</code></div>
<ul><li>
fragments have their own unit-test fragment
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">define frag</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">test_frag_name</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">name</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="type">Frag</span> <span class="fn">f</span>(<span class="var">name</span>, <span class="num">nullptr</span>);<br/>
<span class="in2"></span><span class="fn">ASSERT</span>(<span class="var">f</span>.<span class="var">name</span> == <span class="var">name</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">define frag</span>)</span><br/>
</code></div>
<ul><li>
checks, if the fragment name is copied correctly
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">unit-tests</span>)</span><br/>
<span class="in1"></span><span class="fn">test_frag_name</span>(<span class="str">"abc"</span>);<br/>
<span class="in1"></span><span class="fn">test_frag_name</span>(<span class="str">""</span>);<br/>
<span class="in1"></span><span class="fn">test_frag_name</span>(<span class="str">"A c"</span>);<br/>
<span class="macro">@end(<span class="name">unit-tests</span>)</span><br/>
</code></div>
<ul><li>
verify that names are copied
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">Frag</span> <span class="var">f</span> { <span class="str">"ab"</span>, <span class="num">nullptr</span> };<br/>
<span class="in1"></span><span class="fn">ASSERT</span>(<span class="var">f</span>.<span class="fn">empty</span>());<br/>
} <span class="macro">@end(<span class="name">unit-tests</span>)</span><br/>
</code></div>
<ul><li>
check that a new <code><span class="type">Frag</span></code> has no entries
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">define frag</span>)</span><br/>
<span class="in1"></span><span class="type">bool</span> <span class="fn">isPopulatedFrag</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Frag</span> *<span class="var">f</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">f</span> &amp;&amp; ! <span class="var">f</span>-&gt;<span class="fn">empty</span>();<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">define frag</span>)</span><br/>
</code></div>
<ul><li>
check that a fragment is not empty
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">Frag_Entry</span> <span class="var">entry</span>;<br/>
} <span class="macro">@end(<span class="name">unit-tests</span>)</span><br/>
</code></div>
<ul><li>
verify that an empty fragment has no sub <code><span class="type">Frag</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">Frag</span> <span class="var">f</span> { <span class="str">""</span>, <span class="num">nullptr</span> };<br/>
<span class="in1"></span><span class="type">Write_State</span> <span class="var">s</span> { <span class="var">f</span> };<br/>
<span class="in1"></span><span class="type">Frag_Entry</span> <span class="var">entry</span>;<br/>
<span class="in1"></span><span class="fn">ASSERT</span>(<span class="var">entry</span>.<span class="fn">str</span>(<span class="var">s</span>).<span class="fn">empty</span>());<br/>
} <span class="macro">@end(<span class="name">unit-tests</span>)</span><br/>
</code></div>
<ul><li>
an empty entry will not return any bytes
</li></ul>
</div>
</div>
<h2>Add entries to <code><span class="type">Frag</span></code>s</h2>
<div class="slides">
<div>
<div>
<h2>Add entries to <code><span class="type">Frag</span></code>s</h2>
</div>
<ul><li>
add sub <code><span class="type">Frag</span></code>s or text to a <code><span class="type">Frag</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">frag methods</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">add</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">value</span>,<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">file</span>,<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">line</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">value</span>.<span class="fn">empty</span>()) { <span class="keyword">return</span>; }<br/>
<span class="in2"></span><span class="macro">@mul(<span class="name">assure frag entry</span>)</span>;<br/>
<span class="in2"></span><span class="var">_entries</span>.<span class="fn">back</span>().<span class="fn">add</span>(<br/>
<span class="in3"></span><span class="var">value</span>, <span class="var">file</span>, <span class="var">line</span><br/>
<span class="in2"></span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">frag methods</span>)</span><br/>
</code></div>
<ul><li>
add some text
</li><li>
if the text is empty, nothing is added
</li><li>
otherwise the method assures that there is an entry
</li><li>
and adds text to this entry
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">assure frag entry</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">_entries</span>.<span class="fn">empty</span>()) {<br/>
<span class="in2"></span><span class="var">_entries</span>.<span class="fn">emplace_back</span>();<br/>
<span class="in1"></span>} <span class="keyword">else</span> <span class="keyword">if</span> (<br/>
<span class="in2"></span>! <span class="var">_entries</span>.<span class="fn">back</span>().<span class="fn">canAdd</span>(<br/>
<span class="in3"></span><span class="var">file</span>, <span class="var">line</span><br/>
<span class="in2"></span>)<br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="var">_entries</span>.<span class="fn">emplace_back</span>();<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">assure frag entry</span>)</span><br/>
</code></div>
<ul><li>
if there are no entries, a new one is added
</li><li>
otherwise if the text is at the wrong position, a new one is also added
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">frag methods</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">add</span>(<br/>
<span class="in2"></span><span class="type">char</span> <span class="var">ch</span>,<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">file</span>,<br/>
<span class="in2"></span><span class="type">int</span> <span class="var">line</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@mul(<span class="name">assure frag entry</span>)</span>;<br/>
<span class="in2"></span><span class="var">_entries</span>.<span class="fn">back</span>().<span class="fn">add</span>(<br/>
<span class="in3"></span><span class="var">ch</span>, <span class="var">file</span>, <span class="var">line</span><br/>
<span class="in2"></span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">frag methods</span>)</span><br/>
</code></div>
<ul><li>
adds a single character to the <code><span class="type">Frag</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">frag methods</span>)</span><br/>
<span class="in1"></span><span class="type">Frag</span> &amp;<span class="fn">add</span>(<span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">path</span>, <span class="type">Frag</span> *<span class="var">child</span>, <span class="type">bool</span> <span class="var">local</span>);<br/>
<span class="macro">@end(<span class="name">frag methods</span>)</span><br/>
</code></div>
<ul><li>
adds a sub <code><span class="type">Frag</span></code> to a <code><span class="type">Frag</span></code>
</li><li>
assures that no cycle will result
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">define frag</span>)</span><br/>
<span class="in1"></span><span class="macro">@put(<span class="name">define cycle check</span>)</span><br/>
<span class="in1"></span><span class="type">Frag</span> &amp;<span class="type">Frag</span>::<span class="fn">add</span>(<span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">path</span>, <span class="type">Frag</span> *<span class="var">child</span>, <span class="type">bool</span> <span class="var">local</span>) {<br/>
<span class="in2"></span><span class="fn">ASSERT</span>(<span class="var">child</span>);<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">avoid frag cycles</span>)</span>;<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">add frag entry</span>)</span>;<br/>
<span class="in2"></span><span class="keyword">return</span> *<span class="var">this</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">define frag</span>)</span><br/>
</code></div>
<ul><li>
checks, that the sub <code><span class="type">Frag</span></code> is valid and that no cycles will result
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">add frag entry</span>)</span><br/>
<span class="in1"></span><span class="var">_entries</span>.<span class="fn">push_back</span>(<br/>
<span class="in2"></span><span class="type">Frag_Entry</span> { <span class="type">Frag_Ref</span> { <span class="var">path</span>, <span class="var">child</span>-&gt;<span class="var">name</span>, <span class="var">local</span> } }<br/>
<span class="in1"></span>);<br/>
<span class="macro">@end(<span class="name">add frag entry</span>)</span><br/>
</code></div>
<ul><li>
creates a new entry for the sub <code><span class="type">Frag</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">frag methods</span>)</span><br/>
<span class="in1"></span><span class="type">auto</span> <span class="fn">begin</span>() <span class="type">const</span> {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">_entries</span>.<span class="fn">cbegin</span>();<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">frag methods</span>)</span><br/>
</code></div>
<ul><li>
getter for the begin entries iterator
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">frag methods</span>)</span><br/>
<span class="in1"></span><span class="type">auto</span> <span class="fn">end</span>() <span class="type">const</span> {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">_entries</span>.<span class="fn">cend</span>();<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">frag methods</span>)</span><br/>
</code></div>
<ul><li>
getter for the end entries iterator
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">frag methods</span>)</span><br/>
<span class="in1"></span><span class="type">int</span> <span class="fn">expands</span>() <span class="type">const</span> {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">_expands</span> + (<span class="var">_prefix</span> ? <span class="var">_prefix</span>-&gt;<span class="fn">expands</span>() : <span class="num">0</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">frag methods</span>)</span><br/>
</code></div>
<ul><li>
how often was the <code><span class="type">Frag</span></code> <code>@<span class="var">put</span></code> or <code>@<span class="type">Put</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">frag methods</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">addExpand</span>() {<br/>
<span class="in2"></span>++<span class="var">_expands</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">frag methods</span>)</span><br/>
</code></div>
<ul><li>
increases the <code>@<span class="var">put</span></code> or <code>@<span class="type">Put</span></code> count
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">frag methods</span>)</span><br/>
<span class="in1"></span><span class="type">int</span> <span class="fn">multiples</span>() <span class="type">const</span> {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">_multiples</span> + (<span class="var">_prefix</span> ? <span class="var">_prefix</span>-&gt;<span class="fn">multiples</span>() : <span class="num">0</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">frag methods</span>)</span><br/>
</code></div>
<ul><li>
how often was the <code><span class="type">Frag</span></code> <code>@<span class="var">mul</span></code> or <code>@<span class="type">Mul</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">frag methods</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">addMultiple</span>() {<br/>
<span class="in2"></span>++<span class="var">_multiples</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">frag methods</span>)</span><br/>
</code></div>
<ul><li>
increases the <code>@<span class="var">mul</span></code> or <code>@<span class="type">Mul</span></code> count
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">frag methods</span>)</span><br/>
<span class="in1"></span><span class="type">bool</span> <span class="fn">is_c_style</span>() <span class="type">const</span> {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">is c-style</span>)</span>;<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="num">false</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">frag methods</span>)</span><br/>
</code></div>
<ul><li>
check if a fragment supports C-like line number macros
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">is c-style</span>)</span><br/>
<span class="in1"></span><span class="keyword">static</span> <span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> <span class="var">exts</span>[] = {<br/>
<span class="in2"></span><span class="str">".c"</span>, <span class="str">".h"</span>, <span class="str">".cpp"</span><br/>
<span class="in1"></span>};<br/>
<span class="in1"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> *<span class="var">end</span> =<br/>
<span class="in2"></span><span class="var">exts</span> + <span class="fn">sizeof</span>(<span class="var">exts</span>)/<span class="fn">sizeof</span>(*<span class="var">exts</span>);<br/>
<span class="macro">@end(<span class="name">is c-style</span>)</span><br/>
</code></div>
<ul><li>
array of valid extensions
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">is c-style</span>)</span><br/>
<span class="in1"></span><span class="keyword">for</span> (<span class="type">auto</span> <span class="var">i</span> = <span class="var">exts</span>; <span class="var">i</span> != <span class="var">end</span>; ++<span class="var">i</span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">name</span>.<span class="fn">length</span>() &gt; <span class="var">i</span>-&gt;<span class="fn">length</span>()) {<br/>
<span class="in3"></span><span class="keyword">if</span> (<span class="var">name</span>.<span class="fn">substr</span>(<br/>
<span class="in4"></span><span class="var">name</span>.<span class="fn">length</span>() -<br/>
<span class="in5"></span><span class="var">i</span>-&gt;<span class="fn">length</span>()) == *<span class="var">i</span><br/>
<span class="in3"></span>) {<br/>
<span class="in4"></span><span class="keyword">return</span> <span class="num">true</span>;<br/>
<span class="in3"></span>}<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">is c-style</span>)</span><br/>
</code></div>
<ul><li>
a fragment is of C style, if its name ends in one of the C/C++ file  extensions
</li></ul>
</div>
</div>
<h2>Serialize <code><span class="type">Frag</span></code>s</h2>
<div class="slides">
<div>
<div>
<h2>Serialize <code><span class="type">Frag</span></code>s</h2>
</div>
<ul><li>
write <code><span class="type">Frag</span></code> traversal to a <code><span class="type">std</span>::<span class="type">ostream</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">define frag</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">serializeFrag</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Frag</span> &amp;<span class="var">frag</span>,<br/>
<span class="in2"></span><span class="type">std</span>::<span class="type">ostream</span> &amp;<span class="var">out</span>,<br/>
<span class="in2"></span><span class="type">Write_State</span> &amp;<span class="var">state</span>,<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">path</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">iterate entries</span>)</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">define frag</span>)</span><br/>
</code></div>
<ul><li>
iterate over the entries
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">define frag</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">serializeFrag</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Frag</span> &amp;<span class="var">f</span>,<br/>
<span class="in2"></span><span class="type">std</span>::<span class="type">ostream</span> &amp;<span class="var">out</span>,<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">path</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="type">Write_State</span> <span class="var">state</span> { <span class="var">f</span> };<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="fn">serializeFrag</span>(<br/>
<span class="in3"></span><span class="var">f</span>, <span class="var">out</span>, <span class="var">state</span>, <span class="var">path</span><br/>
<span class="in2"></span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">define frag</span>)</span><br/>
</code></div>
<ul><li>
estimate a <code><span class="type">Write_State</span></code> first
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">iterate entries</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">frag</span>.<span class="fn">prefix</span>()) {<br/>
<span class="in2"></span><span class="fn">serializeFrag</span>(<br/>
<span class="in3"></span>*<span class="var">frag</span>.<span class="fn">prefix</span>(), <span class="var">out</span>, <span class="var">state</span>, <span class="var">path</span><br/>
<span class="in2"></span>);<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="keyword">for</span> (<span class="type">const</span> <span class="type">auto</span> &amp;<span class="var">entry</span> : <span class="var">frag</span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (! <span class="var">entry</span>.<span class="fn">sub</span>().<span class="var">name</span>.<span class="fn">empty</span>()) {<br/>
<span class="in3"></span><span class="type">std</span>::<span class="type">string</span> <span class="var">new_path</span> = <span class="var">path</span>;<br/>
<span class="in3"></span><span class="type">const</span> <span class="type">Frag</span> *<span class="var">f</span> { <span class="fn">find_frag</span>(<span class="var">entry</span>.<span class="fn">sub</span>(), &amp;<span class="var">new_path</span>) };<br/>
<span class="in3"></span><span class="keyword">if</span> (<span class="var">f</span>) {<br/>
<span class="in4"></span><span class="fn">serializeFrag</span>(<br/>
<span class="in5"></span>*<span class="var">f</span>, <span class="var">out</span>, <span class="var">state</span>, <span class="var">new_path</span><br/>
<span class="in4"></span>);<br/>
<span class="in3"></span>} <span class="keyword">else</span> {<br/>
<span class="in4"></span><span class="type">std</span>::<span class="var">cerr</span> &lt;&lt; <span class="str">"no frag ["</span> &lt;&lt; <span class="var">entry</span>.<span class="fn">sub</span>().<span class="var">name</span> &lt;&lt; <span class="str">"], "</span> &lt;&lt; (<span class="var">entry</span>.<span class="fn">sub</span>().<span class="var">local</span> ? <span class="str">"local"</span> : <span class="str">"global"</span> ) &lt;&lt; <span class="str">", ["</span> &lt;&lt; <span class="var">path</span> &lt;&lt; <span class="str">"]\n"</span>;<br/>
<span class="in3"></span>}<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="var">out</span> &lt;&lt; <span class="var">entry</span>.<span class="fn">str</span>(<span class="var">state</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">iterate entries</span>)</span><br/>
</code></div>
<ul><li>
recursively visit sub <code><span class="type">Frag</span></code>s
</li><li>
then write the string value
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">define frag</span>)</span><br/>
<span class="in1"></span><span class="type">bool</span> <span class="fn">check_frag</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Frag</span> &amp;<span class="var">f</span>,<br/>
<span class="in2"></span><span class="type">std</span>::<span class="type">istream</span> &amp;<span class="keyword">in</span>,<br/>
<span class="in2"></span><span class="type">Write_State</span> &amp;<span class="var">state</span>,<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">path</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">check entries</span>)</span>;<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="num">true</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">define frag</span>)</span><br/>
</code></div>
<ul><li>
checks if the traversal results in the same value as a <code><span class="type">std</span>::<span class="type">istream</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">define frag</span>)</span><br/>
<span class="in1"></span><span class="type">bool</span> <span class="fn">check_frag</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Frag</span> &amp;<span class="var">f</span>,<br/>
<span class="in2"></span><span class="type">std</span>::<span class="type">istream</span> &amp;<span class="keyword">in</span>,<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">path</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="type">Write_State</span> <span class="var">state</span> { <span class="var">f</span> };<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="fn">check_frag</span>(<br/>
<span class="in3"></span><span class="var">f</span>, <span class="keyword">in</span>, <span class="var">state</span>, <span class="var">path</span><br/>
<span class="in2"></span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">define frag</span>)</span><br/>
</code></div>
<ul><li>
estimate a <code><span class="type">Write_State</span></code> first
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">check entries</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">f</span>.<span class="fn">prefix</span>()) {<br/>
<span class="in2"></span><span class="keyword">if</span> (! <span class="fn">check_frag</span>(*<span class="var">f</span>.<span class="fn">prefix</span>(), <span class="keyword">in</span>, <span class="var">state</span>, <span class="var">path</span>)) {<br/>
<span class="in3"></span><span class="keyword">return</span> <span class="num">false</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="keyword">for</span> (<span class="type">const</span> <span class="type">auto</span> &amp;<span class="var">entry</span> : <span class="var">f</span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (! <span class="var">entry</span>.<span class="fn">sub</span>().<span class="var">name</span>.<span class="fn">empty</span>()) {<br/>
<span class="in3"></span><span class="type">std</span>::<span class="type">string</span> <span class="var">new_path</span> = <span class="var">path</span>;<br/>
<span class="in3"></span><span class="type">const</span> <span class="type">Frag</span> *<span class="var">f</span> { <span class="fn">find_frag</span>(<span class="var">entry</span>.<span class="fn">sub</span>(), &amp;<span class="var">new_path</span>) };<br/>
<span class="in3"></span><span class="keyword">if</span> (<span class="var">f</span>) {<br/>
<span class="in4"></span><span class="keyword">if</span> (! <span class="fn">check_frag</span>(<br/>
<span class="in5"></span>*<span class="var">f</span>, <span class="keyword">in</span>, <span class="var">state</span>, <span class="var">new_path</span><br/>
<span class="in4"></span>)) {<br/>
<span class="in5"></span><span class="keyword">return</span> <span class="num">false</span>;<br/>
<span class="in4"></span>}<br/>
<span class="in3"></span>}<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">check entry str</span>)</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">check entries</span>)</span><br/>
</code></div>
<ul><li>
recursively visit sub <code><span class="type">Frag</span></code>s
</li><li>
then compare the string value
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">check entry str</span>)</span><br/>
<span class="in1"></span><span class="keyword">for</span> (<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">auto</span> &amp;<span class="var">i</span> : <span class="var">entry</span>.<span class="fn">str</span>(<span class="var">state</span>)<br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="keyword">in</span>.<span class="fn">get</span>() != <span class="var">i</span>) {<br/>
<span class="in3"></span><span class="keyword">return</span> <span class="num">false</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">check entry str</span>)</span><br/>
</code></div>
<ul><li>
compare string value character by character
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">define frag</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">testFrag</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Frag</span> &amp;<span class="var">frag</span>,<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">expected</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">serialize test frag</span>)</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">define frag</span>)</span><br/>
</code></div>
<ul><li>
verifies that a <code><span class="type">Frag</span></code> serializes as expected
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">includes</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">sstream</span>&gt;<br/>
<span class="macro">@end(<span class="name">includes</span>)</span><br/>
</code></div>
<ul><li>
needs <code><span class="type">std</span>::<span class="var">ostringstream</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">serialize test frag</span>)</span><br/>
<span class="in1"></span><span class="type">std</span>::<span class="var">ostringstream</span> <span class="var">buffer</span>;<br/>
<span class="in1"></span><span class="fn">serializeFrag</span>(<span class="var">frag</span>, <span class="var">buffer</span>, <span class="str">""</span>);<br/>
<span class="in1"></span><span class="fn">ASSERT</span>(<span class="var">buffer</span>.<span class="fn">str</span>() == <span class="var">expected</span>);<br/>
<span class="macro">@end(<span class="name">serialize test frag</span>)</span><br/>
</code></div>
<ul><li>
serializes the <code><span class="type">Frag</span></code>
</li><li>
and compares resulting value
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">define frag</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">addStringToFrag</span>(<br/>
<span class="in2"></span><span class="type">Frag</span> *<span class="var">frag</span>,<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">str</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="var">frag</span>-&gt;<span class="fn">add</span>(<br/>
<span class="in3"></span><span class="var">str</span>, <span class="type">std</span>::<span class="type">string</span> {}, <span class="num">0</span><br/>
<span class="in2"></span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">define frag</span>)</span><br/>
</code></div>
<ul><li>
adds a zero-terminated string to a <code><span class="type">Frag</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="fn">clear_frags</span>();<br/>
<span class="in1"></span><span class="type">Frag</span> <span class="var">frag</span> { <span class="str">"a"</span>, <span class="num">nullptr</span> };<br/>
<span class="in1"></span><span class="fn">addStringToFrag</span>(&amp;<span class="var">frag</span>, <span class="str">"abc"</span>);<br/>
<span class="in1"></span><span class="fn">addStringToFrag</span>(&amp;<span class="var">frag</span>, <span class="str">"def"</span>);<br/>
<span class="in1"></span><span class="fn">testFrag</span>(<span class="var">frag</span>, <span class="str">"abcdef"</span>);<br/>
} <span class="macro">@end(<span class="name">unit-tests</span>)</span><br/>
</code></div>
<ul><li>
checks that two strings are correctly serialized
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="fn">clear_frags</span>();<br/>
<span class="in1"></span><span class="type">Frag</span> &amp;<span class="var">a</span> { <span class="fn">get_frag</span>(<span class="str">""</span>, <span class="str">"a"</span>, <span class="num">true</span>) };<br/>
<span class="in1"></span><span class="type">Frag</span> &amp;<span class="var">b</span> { <span class="fn">get_frag</span>(<span class="str">""</span>, <span class="str">"b"</span>, <span class="num">true</span>) };<br/>
<span class="in1"></span><span class="fn">addStringToFrag</span>(&amp;<span class="var">a</span>, <span class="str">"abc"</span>);<br/>
<span class="in1"></span><span class="var">b</span>.<span class="fn">add</span>(<span class="str">""</span>, &amp;<span class="var">a</span>, <span class="num">true</span>);<br/>
<span class="in1"></span><span class="fn">addStringToFrag</span>(&amp;<span class="var">b</span>, <span class="str">"def"</span>);<br/>
<span class="in1"></span><span class="var">b</span>.<span class="fn">add</span>(<span class="str">""</span>, &amp;<span class="var">a</span>, <span class="num">true</span>);<br/>
<span class="in1"></span><span class="fn">testFrag</span>(<span class="var">b</span>, <span class="str">"abcdefabc"</span>);<br/>
} <span class="macro">@end(<span class="name">unit-tests</span>)</span><br/>
</code></div>
<ul><li>
checks that sub <code><span class="type">Frag</span></code>s are serialized correctly
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="fn">clear_frags</span>();<br/>
<span class="in1"></span><span class="type">Frag</span> &amp;<span class="var">a</span> { <span class="fn">get_frag</span>(<span class="str">""</span>, <span class="str">"a"</span>, <span class="num">false</span>) };<br/>
<span class="in1"></span><span class="type">Frag</span> &amp;<span class="var">b</span> { <span class="fn">get_frag</span>(<span class="str">""</span>, <span class="str">"b"</span>, <span class="num">true</span>) };<br/>
<span class="in1"></span><span class="fn">addStringToFrag</span>(&amp;<span class="var">a</span>, <span class="str">"abc"</span>);<br/>
<span class="in1"></span><span class="var">b</span>.<span class="fn">add</span>(<span class="str">""</span>, &amp;<span class="var">a</span>, <span class="num">true</span>);<br/>
<span class="in1"></span><span class="fn">addStringToFrag</span>(&amp;<span class="var">b</span>, <span class="str">"def"</span>);<br/>
<span class="in1"></span><span class="var">b</span>.<span class="fn">add</span>(<span class="str">""</span>, &amp;<span class="var">a</span>, <span class="num">false</span>);<br/>
<span class="in1"></span><span class="fn">testFrag</span>(<span class="var">b</span>, <span class="str">"abcdefabc"</span>);<br/>
} <span class="macro">@end(<span class="name">unit-tests</span>)</span><br/>
</code></div>
<ul><li>
checks that sub <code><span class="type">Frag</span></code>s are serialized correctly
</li></ul>
</div>
</div>
<h2>Cycle detection</h2>
<div class="slides">
<div>
<div>
<h2>Cycle detection</h2>
</div>
<ul><li>
checks if the addition of a sub <code><span class="type">Frag</span></code> would result in a cycle
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">define cycle check</span>)</span><br/>
<span class="in1"></span><span class="type">bool</span> <span class="fn">isFragInFrag</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">path</span>,<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Frag</span> *<span class="var">needle</span>,<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Frag</span> *<span class="var">haystack</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="fn">ASSERT</span>(<span class="var">needle</span>);<br/>
<span class="in2"></span><span class="fn">ASSERT</span>(<span class="var">haystack</span>);<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">check cycle frag</span>)</span>;<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">check cycle entries</span>)</span>;<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="num">false</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">define cycle check</span>)</span><br/>
</code></div>
<ul><li>
checks, if the parent <code><span class="type">Frag</span></code> <code><span class="var">needle</span></code> is already present in the <code><span class="var">DAG</span></code>  starting at the sub <code><span class="type">Frag</span></code> <code><span class="var">haystack</span></code>
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">avoid frag cycles</span>)</span><br/>
<span class="in1"></span><span class="fn">ASSERT</span>(! <span class="fn">isFragInFrag</span>(<br/>
<span class="in2"></span><span class="var">path</span>, <span class="var">this</span>, <span class="var">child</span><br/>
<span class="in1"></span>));<br/>
<span class="macro">@end(<span class="name">avoid frag cycles</span>)</span><br/>
</code></div>
<ul><li>
a sub <code><span class="type">Frag</span></code> can not be added, if a cycle would result
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">check cycle frag</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">needle</span> == <span class="var">haystack</span>) {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="num">true</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">check cycle frag</span>)</span><br/>
</code></div>
<ul><li>
if the container is itself the searched <code><span class="type">Frag</span></code>, a cycle would result
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">check cycle entries</span>)</span><br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">haystack</span>-&gt;<span class="fn">prefix</span>() &amp;&amp; <span class="fn">isFragInFrag</span>(<span class="var">path</span>, <span class="var">needle</span>, <span class="var">haystack</span>-&gt;<span class="fn">prefix</span>())) {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="num">true</span>;<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="keyword">for</span> (<span class="type">const</span> <span class="type">auto</span> &amp;<span class="var">i</span> : *<span class="var">haystack</span>)  {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">i</span>.<span class="fn">sub</span>().<span class="var">name</span>.<span class="fn">empty</span>()) { <span class="keyword">continue</span>; }<br/>
<span class="in2"></span><span class="type">std</span>::<span class="type">string</span> <span class="var">new_path</span> { <span class="var">path</span> };<br/>
<span class="in2"></span><span class="type">Frag</span> *<span class="var">f</span> { <span class="fn">find_frag</span>(<span class="var">i</span>.<span class="fn">sub</span>(), &amp;<span class="var">new_path</span>) };<br/>
<span class="in2"></span><span class="keyword">if</span> (! <span class="var">f</span>) { <span class="keyword">continue</span>; }<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="fn">isFragInFrag</span>(<br/>
<span class="in3"></span><span class="var">new_path</span>, <span class="var">needle</span>, <span class="var">f</span><br/>
<span class="in2"></span>)) {<br/>
<span class="in3"></span><span class="keyword">return</span> <span class="num">true</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">check cycle entries</span>)</span><br/>
</code></div>
<ul><li>
otherwise all sub <code><span class="type">Frag</span></code>s will be searched
</li><li>
as soon as a cycle is found, the search can be aborted
</li></ul>
</div>
</body>
</html>
