<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Eingabe-Dateien</title>
<link rel="stylesheet" type="text/css" href="slides/slides.css"></head>
<body>
<h1>Eingabe-Dateien</h1>
<div class="slides">
<div>
<div>
<h1>Eingabe-Dateien</h1>
</div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">includes</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">iostream</span>&gt;<br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="type">vector</span>&gt;<br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">filesystem</span>&gt;<br/>
<span class="macro">@end(<span class="name">includes</span>)</span><br/>
</code></div>
<ul><li>
<code><span class="type">vector</span></code> ist ein Container für Source-Dateien
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">private inputs elements</span>)</span><br/>
<span class="in1"></span><span class="type">FragMap</span> <span class="var">_root</span>;<br/>
<span class="macro">@End(<span class="name">private inputs elements</span>)</span><br/>
</code></div>
<ul><li>
Kollektion mit allen Fragmenten wird für folgende Schritte sichtbar  angelegt
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">inputs elements</span>)</span><br/>
<span class="in1"></span><span class="type">auto</span> &amp;<span class="fn">cur</span>() {<br/>
<span class="in2"></span><span class="var">ASSERT</span> (! <span class="var">_open</span>.<span class="fn">empty</span>());<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">_open</span>.<span class="fn">back</span>();<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">inputs elements</span>)</span><br/>
</code></div>
<ul><li>
Liefert zuletzt geöffnete Datei
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">inputs elements</span>)</span><br/>
<span class="in1"></span><span class="type">auto</span> <span class="fn">begin</span>() {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">_used</span>.<span class="fn">begin</span>();<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">inputs elements</span>)</span><br/>
</code></div>
<ul><li>
Liefert erste benutzte Datei
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">inputs elements</span>)</span><br/>
<span class="in1"></span><span class="type">auto</span> <span class="fn">end</span>() {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">_used</span>.<span class="fn">end</span>();<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">inputs elements</span>)</span><br/>
</code></div>
<ul><li>
Liefert zuletzt benutzte Datei
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">inputs elements</span>)</span><br/>
<span class="in1"></span><span class="type">auto</span> <span class="fn">size</span>() <span class="type">const</span> {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">_used</span>.<span class="fn">size</span>();<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">inputs elements</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">inputs elements</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">push</span>(<span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">path</span>) {<br/>
<span class="in2"></span><span class="var">_used</span>.<span class="fn">push_back</span>({ <span class="var">path</span> });<br/>
<span class="in2"></span><span class="var">_open</span>.<span class="fn">push_back</span>({ <span class="var">path</span> });<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">inputs elements</span>)</span><br/>
</code></div>
<ul><li>
Dateien werden über ihren Pfad identifiziert
</li><li>
Dieser wird als Name gespeichert
</li><li>
Das Verschieben der Ownership muss aber explizit erfolgen
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">inputs elements</span>)</span><br/>
<span class="in1"></span><span class="type">void</span> <span class="fn">add</span>(<span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">path</span>) {<br/>
<span class="in2"></span><span class="var">_paths</span>.<span class="fn">push_back</span>(<span class="var">path</span>);<br/>
<span class="in2"></span><span class="fn">push</span>(<span class="var">path</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">inputs elements</span>)</span><br/>
</code></div>
</div>
</div>
<h1>Nächste Zeile</h1>
<div class="slides">
<div>
<div>
<h1>Nächste Zeile</h1>
</div>
<ul><li>
Die Funktion <code><span class="fn">read_line</span></code> liest die nächste Zeile aus der  aktuellen  Datei
</li><li>
Wenn das Dateiende erreicht ist, wird die nächste Datei aus dem  Stapel der offenen Dateien geholt
</li><li>
Erst wenn die letzte Datei fertig gelesen wurde, wird <code><span class="num">false</span></code>  zurück  geliefert
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">inputs elements</span>)</span><br/>
<span class="in1"></span><span class="type">bool</span> <span class="fn">has</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">name</span><br/>
<span class="in1"></span>) <span class="type">const</span> {<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">has checks</span>)</span>;<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="num">false</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">inputs elements</span>)</span><br/>
</code></div>
<ul><li>
Prüft ob eine Datei bereits verwendet wurde
</li><li>
Alle bearbeiteten Dateien werden inspiziert
</li><li>
Dadurch wird bei Einbettungen verhindert, dass eine Datei mehrfach  verarbeitet wird
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">has checks</span>)</span><br/>
<span class="in1"></span><span class="keyword">for</span> (<span class="type">const</span> <span class="type">auto</span> &amp;<span class="var">j</span> : <span class="var">_used</span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">j</span>.<span class="fn">path</span>() == <span class="var">name</span>) {<br/>
<span class="in3"></span><span class="keyword">return</span> <span class="num">true</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">has checks</span>)</span><br/>
</code></div>
<ul><li>
Bereits verarbeitete Dateien werden geprüft
</li></ul>
</div>
</div>
<h1>Lokale Fragmente</h1>
<div class="slides">
<div>
<div>
<h1>Lokale Fragmente</h1>
</div>
<ul><li>
Jede Datei hat eine eigene Fragment-Kollektion
</li><li>
Die Kollektionen bereits offener Dateien werden hierarchisch  integriert
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">input elements</span>)</span><br/>
<span class="in1"></span><span class="type">FragMap</span> <span class="var">frags</span>;<br/>
<span class="macro">@end(<span class="name">input elements</span>)</span><br/>
</code></div>
<ul><li>
Jede Source-Datei hat eine eigene Fragment-Map mit lokalen  Definitionen
</li></ul>
</div>
</div>
<h1>Zeilennummern</h1>
<div class="slides">
<div>
<div>
<h1>Zeilennummern</h1>
</div>
<ul><li>
Jede Datei führt die aktuelle Zeiennummer mit
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">private open input els</span>)</span><br/>
<span class="in1"></span><span class="type">int</span> <span class="var">_line</span> = <span class="num">0</span>;<br/>
<span class="macro">@end(<span class="name">private open input els</span>)</span><br/>
</code></div>
<ul><li>
Pro Datei wird die aktuelle Zeile festgehalten
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">open input elements</span>)</span><br/>
<span class="in1"></span><span class="type">int</span> <span class="fn">line</span>() <span class="type">const</span> {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">_line</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@end(<span class="name">open input elements</span>)</span><br/>
</code></div>
<ul><li>
Liefert Zeilennummer
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Def(<span class="name">line read</span>)</span><br/>
<span class="in1"></span>++<span class="var">_line</span>;<br/>
<span class="macro">@End(<span class="name">line read</span>)</span><br/>
</code></div>
<ul><li>
Zeilennummer wird erhöht
</li></ul>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">inputs elements</span>)</span><br/>
<span class="in1"></span><span class="type">Frag</span> *<span class="fn">find_local</span>(<span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">name</span>) {<br/>
<span class="in2"></span><span class="fn">ASSERT</span>(! <span class="var">_open</span>.<span class="fn">empty</span>());<br/>
<span class="in2"></span><span class="type">Input</span> &amp;<span class="var">i</span> = <span class="var">_open</span>.<span class="fn">back</span>().<span class="fn">input</span>();<br/>
<span class="in2"></span><span class="type">auto</span> <span class="var">f</span> = <span class="var">i</span>.<span class="var">frags</span>.<span class="fn">find</span>(<span class="var">name</span>);<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">f</span> == <span class="var">i</span>.<span class="var">frags</span>.<span class="fn">end</span>()) { <span class="keyword">return</span> <span class="num">nullptr</span>; }<br/>
<span class="in2"></span><span class="keyword">return</span> &amp;<span class="var">f</span>-&gt;<span class="var">second</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">inputs elements</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">inputs elements</span>)</span><br/>
<span class="in1"></span><span class="type">Frag</span> *<span class="fn">add_local</span>(<span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">name</span>) {<br/>
<span class="in2"></span><span class="fn">ASSERT</span>(! <span class="var">_open</span>.<span class="fn">empty</span>());<br/>
<span class="in2"></span><span class="type">Input</span> &amp;<span class="var">i</span> = <span class="var">_open</span>.<span class="fn">back</span>().<span class="fn">input</span>();<br/>
<span class="in2"></span><span class="keyword">return</span> &amp;<span class="var">i</span>.<span class="var">frags</span>.<span class="fn">insert</span>({ <span class="var">name</span>, <span class="var">name</span> }).<span class="var">first</span>-&gt;<span class="var">second</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">inputs elements</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">inputs elements</span>)</span><br/>
<span class="in1"></span><span class="type">Frag</span> *<span class="fn">get_local</span>(<span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">name</span>) {<br/>
<span class="in2"></span><span class="type">Frag</span> *<span class="var">result</span> = <span class="fn">find_local</span>(<span class="var">name</span>);<br/>
<span class="in2"></span><span class="keyword">if</span> (! <span class="var">result</span>) {<br/>
<span class="in3"></span><span class="var">result</span> = <span class="fn">add_local</span>(<span class="var">name</span>);<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">result</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">inputs elements</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">inputs elements</span>)</span><br/>
<span class="in1"></span><span class="type">Frag</span> *<span class="fn">find_global</span>(<span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">name</span>) {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">_open</span>.<span class="fn">size</span>() &gt; <span class="num">1</span>) {<br/>
<span class="in3"></span><span class="type">auto</span> <span class="var">i</span> = <span class="var">_open</span>.<span class="fn">end</span>() - <span class="num">2</span>;<br/>
<span class="in3"></span><span class="keyword">for</span> (;; --<span class="var">i</span>) {<br/>
<span class="in4"></span><span class="type">auto</span> &amp;<span class="var">fs</span> = <span class="var">i</span>-&gt;<span class="fn">input</span>().<span class="var">frags</span>;<br/>
<span class="in4"></span><span class="type">auto</span> <span class="var">f</span> = <span class="var">fs</span>.<span class="fn">find</span>(<span class="var">name</span>);<br/>
<span class="in4"></span><span class="keyword">if</span> (<span class="var">f</span> != <span class="var">fs</span>.<span class="fn">end</span>()) {<br/>
<span class="in5"></span><span class="keyword">return</span> &amp;<span class="var">f</span>-&gt;<span class="var">second</span>;<br/>
<span class="in4"></span>}<br/>
<span class="in4"></span><span class="keyword">if</span> (<span class="var">i</span> == <span class="var">_open</span>.<span class="fn">begin</span>()) { <span class="keyword">break</span>; }<br/>
<span class="in3"></span>}<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="type">auto</span> <span class="var">f</span> = <span class="var">_root</span>.<span class="fn">find</span>(<span class="var">name</span>);<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">f</span> == <span class="var">_root</span>.<span class="fn">end</span>()) { <span class="keyword">return</span> <span class="num">nullptr</span>; }<br/>
<span class="in2"></span><span class="keyword">return</span> &amp;<span class="var">f</span>-&gt;<span class="var">second</span>;<br/>
<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">inputs elements</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">inputs elements</span>)</span><br/>
<span class="in1"></span><span class="type">Frag</span> *<span class="fn">add_global</span>(<span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">name</span>) {<br/>
<span class="in2"></span><span class="keyword">return</span> &amp;<span class="var">_root</span>.<span class="fn">insert</span>({ <span class="var">name</span>, <span class="var">name</span> }).<span class="var">first</span>-&gt;<span class="var">second</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">inputs elements</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">inputs elements</span>)</span><br/>
<span class="in1"></span><span class="type">const</span> <span class="type">FragMap</span> &amp;<span class="fn">root</span>() <span class="type">const</span> {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">_root</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">inputs elements</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">inputs elements</span>)</span><br/>
<span class="in1"></span><span class="type">Frag</span> *<span class="fn">get_global</span>(<span class="type">const</span> <span class="type">std</span>::<span class="type">string</span> &amp;<span class="var">name</span>) {<br/>
<span class="in2"></span><span class="type">Frag</span> *<span class="var">result</span> = <span class="fn">find_global</span>(<span class="var">name</span>);<br/>
<span class="in2"></span><span class="keyword">if</span> (! <span class="var">result</span>) {<br/>
<span class="in3"></span><span class="var">result</span> = <span class="fn">add_global</span>(<span class="var">name</span>);<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">result</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">inputs elements</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Def(<span class="name">clear inputs</span>)</span><br/>
<span class="in1"></span><span class="var">_used</span>.<span class="fn">clear</span>();<br/>
<span class="in1"></span><span class="var">_open</span>.<span class="fn">clear</span>();<br/>
<span class="in1"></span><span class="keyword">if</span> (<span class="var">_paths</span>.<span class="fn">empty</span>()) {<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="type">std</span>::<span class="var">filesystem</span>::<span class="fn">exists</span>(<span class="str">"index.md"</span>)) {<br/>
<span class="in3"></span><span class="var">_paths</span>.<span class="fn">push_back</span>(<span class="str">"index.md"</span>);<br/>
<span class="in2"></span>} <span class="keyword">else</span> <span class="keyword">if</span> (<span class="type">std</span>::<span class="var">filesystem</span>::<span class="fn">exists</span>(<span class="str">"index.x"</span>)) {<br/>
<span class="in3"></span><span class="var">_paths</span>.<span class="fn">push_back</span>(<span class="str">"index.x"</span>);<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>}<br/>
<span class="in1"></span><span class="var">_current_path</span> = <span class="var">_paths</span>.<span class="fn">begin</span>();<br/>
<span class="macro">@End(<span class="name">clear inputs</span>)</span><br/>
</code></div>
</div>
</body>
</html>
