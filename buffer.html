<!doctype html>
<html lang="de"l>
<head>
<meta charset="utf-8">
<title>Buffer</title><link rel="stylesheet" type="text/css" href="slides/slides.css"></head>
<body>
<h1>Buffer</h1>
<div class="slides">
<div><div>
<h1>Buffer</h1>
</div>
<ul><li>
 Beschreibt ein Interface um mit Byte-Buffern umgehen zu können</li><li>
 Die Länge dieser Buffer kann dynamisch wachsen</li></ul></div>
<div><div>
<code>
<span class="add">@add(<span class="name">global elements)</span></span><br/>
<span class="in1"></span>
<span class="expand">@expand(<span class="name">define buffer)</span></span>;<br/>

<span class="end">@end(<span class="name">global elements)</span></span><br/>
</code>
</div>
</div>
<div><div>
<code>
<span class="add">@def(<span class="name">perform unit tests)</span></span><br/>
<span class="in1"></span>
<span class="expand">@expand(<span class="name">buffer unit tests)</span></span>;<br/>

<span class="end">@end(<span class="name">perform unit tests)</span></span><br/>
</code>
</div>
</div>
</div>
<h1>Struktur</h1>
<div class="slides">
<div><div>
<h1>Struktur</h1>
</div>
</div>
<div><div>
<code>
<span class="add">@def(<span class="name">define buffer)</span></span><br/>
<span class="in1"></span>
#define INIT_BUFFER_SIZE 16<br/>

<br/>
<span class="in2"></span>
<span class="type">struct Buffer</span> {<br/>
<span class="in2"></span>
<span class="type">char</span> <span class="var">initial</span><span class="type">[INIT_BUFFER_SIZE]</span>;<br/>
<span class="in2"></span>
<span class="type">char *</span><span class="var">buffer</span>;<br/>
<span class="in2"></span>
<span class="type">char *</span><span class="var">current</span>;<br/>
<span class="in2"></span>
<span class="type">const char *</span><span class="var">end</span>;<br/>
<span class="in1"></span>
};<br/>

<span class="end">@end(<span class="name">define buffer)</span></span><br/>
</code>
</div>
<ul><li>
 Bei weiteren Bytes wird der Speicher im Heap angelegt</li></ul></div>
</div>
<h1>Zeichen hinzufügen</h1>
<div class="slides">
<div><div>
<h1>Zeichen hinzufügen</h1>
</div>
</div>
<div><div>
<code>
<span class="add">@add(<span class="name">define buffer)</span></span><br/>
<span class="in1"></span>
<span class="type">void</span> <span class="fn">addToBuffer</span>(<br/>
<span class="in2"></span>
<span class="type">struct Buffer *</span><span class="var">buffer</span>, <span class="type">char</span> ch<br/>
<span class="in1"></span>
) {<br/>
<span class="in2"></span>
<span class="fn">ASSERT</span>(<span class="var">buffer</span>);<br/>
<span class="in2"></span>
<span class="expand">@expand(<span class="name">may initialize buffer)</span></span><br/>
<span class="in2"></span>
<span class="expand">@expand(<span class="name">assure buffer size)</span></span><br/>
<span class="in2"></span>
*<span class="var">buffer</span>-&gt;<span class="var">current</span>++ = <span class="var">ch</span>;<br/>
<span class="in1"></span>
}<br/>

<span class="end">@end(<span class="name">define buffer)</span></span><br/>
</code>
</div>
<ul><li>
 Das ermöglicht die Initialisierung als Literal</li><li>
 Zusätzlich muss sicher gestellt werden, dass ein weiteres Byte angefügt
  werden kann</li><li>
 Dann wird das Byte angefügt</li></ul></div>
<div><div>
<code>
<span class="add">@def(<span class="name">may initialize buffer)</span></span><br/>
<span class="in1"></span>
<span class="keyword">if</span> (! <span class="var">buffer</span>-&gt;<span class="var">buffer</span>) {<br/>
<span class="in2"></span>
<span class="var">buffer</span>-&gt;<span class="var">buffer</span> =<br/>
<span class="in3"></span>
<span class="var">buffer</span>-&gt;<span class="var">initial</span>;<br/>
<span class="in2"></span>
<span class="var">buffer</span>-&gt;<span class="var">current</span> =<br/>
<span class="in3"></span>
<span class="var">buffer</span>-&gt;<span class="var">buffer</span>;<br/>
<span class="in2"></span>
<span class="var">buffer</span>-&gt;<span class="var">end</span> =<br/>
<span class="in3"></span>
<span class="var">buffer</span>-&gt;<span class="var">initial</span> +<br/>
<span class="in4"></span>
INIT_BUFFER_SIZE;<br/>
<span class="in1"></span>
}<br/>

<span class="end">@end(<span class="name">may initialize buffer)</span></span><br/>
</code>
</div>
<ul><li>
 Das stellt sicher, dass ein initialisierter Buffer keinen Speicher im
  Heap belegt</li><li>
 Mit &lt;code class="fn"&gt;eraseBuffer&lt;/code&gt; kann ggf. vorhandener
  Heap-Speicher freigegeben werden</li><li>
 Und der Buffer trotzdem weiter benutzt werden</li></ul></div>
<div><div>
<code>
<span class="add">@def(<span class="name">assure buffer size)</span></span><br/>
<span class="in1"></span>
<span class="keyword">if</span> (<br/>
<span class="in2"></span>
<span class="var">buffer</span>-&gt;<span class="var">current</span> &gt;= <span class="var">buffer</span>-&gt;<span class="var">end</span><br/>
<span class="in1"></span>
) {<br/>
<span class="in2"></span>
<span class="type">int</span> <span class="var">size</span> = <span class="var">buffer</span>-&gt;<span class="var">current</span> -<br/>
<span class="in3"></span>
<span class="var">buffer</span>-&gt;<span class="var">buffer</span>;<br/>
<span class="in2"></span>
<span class="type">int</span> <span class="var">newSize</span> = <span class="num">2</span> * <span class="var">size</span>;<br/>
<span class="in2"></span>
<span class="expand">@expand(<span class="name">reallocate buffer)</span></span>;<br/>
<span class="in1"></span>
}<br/>

<span class="end">@end(<span class="name">assure buffer size)</span></span><br/>
</code>
</div>
</div>
<div><div>
<code>
<span class="add">@def(<span class="name">reallocate buffer)</span></span><br/>
<span class="in1"></span>
<span class="type">char *</span><span class="var">newBuffer</span>;<br/>
<span class="in1"></span>
<span class="keyword">if</span> (<br/>
<span class="in2"></span>
<span class="var">buffer</span>-&gt;<span class="var">buffer</span> == <span class="var">buffer</span>-&gt;<span class="var">initial</span><br/>
<span class="in1"></span>
) {<br/>
<span class="in2"></span>
<span class="var">newBuffer</span> = <span class="fn">malloc</span>(<span class="var">newSize</span>);<br/>
<span class="in2"></span>
<span class="expand">@expand(<span class="name">copy initial buffer)</span></span>;<br/>
<span class="in1"></span>
} <span class="keyword">else</span> {<br/>
<span class="in2"></span>
<span class="var">newBuffer</span> = <span class="fn">realloc</span>(<br/>
<span class="in3"></span>
<span class="var">buffer</span>-&gt;<span class="var">buffer</span>, <span class="var">newSize</span>);<br/>
<span class="in1"></span>
}<br/>
<span class="in1"></span>
<span class="expand">@expand(<span class="name">adjust buffer pointers)</span></span>;<br/>

<span class="end">@end(<span class="name">reallocate buffer)</span></span><br/>
</code>
</div>
<ul><li>
 Andernfalls kann der Speicherblock im Heap vergrößert werden</li></ul></div>
<div><div>
<code>
<span class="add">@def(<span class="name">copy initial buffer)</span></span><br/>
<span class="in1"></span>
<span class="fn">ASSERT</span>(<span class="var">newBuffer</span>);<br/>
<span class="in1"></span>
<span class="fn">memcpy</span>(<br/>
<span class="in2"></span>
<span class="var">newBuffer</span>, <span class="var">buffer</span>-&gt;<span class="var">buffer</span>, <span class="var">size</span><br/>
<span class="in1"></span>
);<br/>

<span class="end">@end(<span class="name">copy initial buffer)</span></span><br/>
</code>
</div>
</div>
<div><div>
<code>
<span class="add">@def(<span class="name">adjust buffer pointers)</span></span><br/>
<span class="in1"></span>
<span class="fn">ASSERT</span>(<span class="var">newBuffer</span>);<br/>
<span class="in1"></span>
<span class="var">buffer</span>-&gt;<span class="var">buffer</span> = <span class="var">newBuffer</span>;<br/>
<span class="in1"></span>
<span class="var">buffer</span>-&gt;<span class="var">current</span> = <span class="var">newBuffer</span> + <span class="var">size</span>;<br/>
<span class="in1"></span>
<span class="var">buffer</span>-&gt;<span class="var">end</span> = <span class="var">newBuffer</span> + <span class="var">newSize</span>;<br/>

<span class="end">@end(<span class="name">adjust buffer pointers)</span></span><br/>
</code>
</div>
</div>
</div>
<h1>Buffer zurücksetzen</h1>
<div class="slides">
<div><div>
<h1>Buffer zurücksetzen</h1>
</div>
</div>
<div><div>
<code>
<span class="add">@add(<span class="name">define buffer)</span></span><br/>
<span class="in1"></span>
<span class="type">void</span> <span class="fn">resetBuffer</span>(<br/>
<span class="in2"></span>
<span class="type">struct Buffer *</span><span class="var">buffer</span><br/>
<span class="in1"></span>
) {<br/>
<span class="in2"></span>
<span class="fn">ASSERT</span>(<span class="var">buffer</span>);<br/>
<span class="in2"></span>
<span class="var">buffer</span>-&gt;<span class="var">current</span> = <span class="var">buffer</span>-&gt;<span class="var">buffer</span>;<br/>
<span class="in1"></span>
}<br/>

<span class="end">@end(<span class="name">define buffer)</span></span><br/>
</code>
</div>
<ul><li>
 Das funktioniert auch, wenn der initiale Buffer verwendet wird</li><li>
 Oder die Zeiger noch &lt;code class="keyword"&gt;NULL&lt;/code&gt; sind</li><li>
 Es wird kein Speicher freigegeben</li></ul></div>
<div><div>
<code>
<span class="add">@add(<span class="name">define buffer)</span></span><br/>
<span class="in1"></span>
<span class="type">void</span> <span class="fn">eraseBuffer</span>(<br/>
<span class="in2"></span>
<span class="type">struct Buffer *</span><span class="var">buffer</span><br/>
<span class="in1"></span>
) {<br/>
<span class="in2"></span>
<span class="fn">ASSERT</span>(<span class="var">buffer</span>);<br/>
<span class="in2"></span>
<span class="expand">@expand(<span class="name">erase heap buffer)</span></span>;<br/>
<span class="in2"></span>
<span class="var">buffer</span>-&gt;<span class="var">current</span> = <span class="var">buffer</span>-&gt;<span class="var">buffer</span>;<br/>
<span class="in1"></span>
}<br/>

<span class="end">@end(<span class="name">define buffer)</span></span><br/>
</code>
</div>
<ul><li>
 Zusätzlich wird der aktuelle Zeiger auf den Anfang zurückgesetzt</li></ul></div>
<div><div>
<code>
<span class="add">@def(<span class="name">erase heap buffer)</span></span><br/>
<span class="in1"></span>
<span class="keyword">if</span> (<span class="var">buffer</span>-&gt;<span class="var">buffer</span> &&<br/>
<span class="in2"></span>
<span class="var">buffer</span>-&gt;<span class="var">buffer</span> != <span class="var">buffer</span>-&gt;<span class="var">initial</span><br/>
<span class="in1"></span>
) {<br/>
<span class="in2"></span>
<span class="fn">free</span>(<span class="var">buffer</span>-&gt;<span class="var">buffer</span>);<br/>
<span class="in2"></span>
<span class="var">buffer</span>-&gt;<span class="var">buffer</span> = <span class="var">buffer</span>-&gt;<span class="var">initial</span>;<br/>
<span class="in1"></span>
}<br/>

<span class="end">@end(<span class="name">erase heap buffer)</span></span><br/>
</code>
</div>
<ul><li>
 Und der Buffer-Zeiger wird gelöscht</li></ul></div>
</div>
<h1>Unit Tests</h1>
<div class="slides">
<div><div>
<h1>Unit Tests</h1>
</div>
</div>
<div><div>
<code>
<span class="add">@def(<span class="name">buffer unit tests)</span></span> {<br/>
<span class="in1"></span>
<span class="type">struct Buffer</span> <span class="var">buffer</span> = {};<br/>
<span class="in1"></span>
<span class="fn">addToBuffer</span>(&<span class="var">buffer</span>, <span class="str">'x'</span>);<br/>
<span class="in1"></span>
<span class="fn">ASSERT</span>(*<span class="var">buffer</span>.<span class="var">buffer</span> == <span class="str">'x'</span>);<br/>
<span class="in1"></span>
<span class="fn">ASSERT</span>(<span class="var">buffer</span>.<span class="var">buffer</span> + 1 ==<br/>
<span class="in2"></span>
<span class="var">buffer</span>.<span class="var">current</span>);<br/>
<span class="in1"></span>
<span class="fn">ASSERT</span>(<span class="var">buffer</span>.<span class="var">buffer</span> ==<br/>
<span class="in2"></span>
<span class="var">buffer</span>.<span class="var">initial</span>);<br/>

} <span class="end">@end(<span class="name">buffer unit tests)</span></span><br/>
</code>
</div>
<ul><li>
 Danach ist ein Byte belegt</li><li>
 Und nur der initiale Buffer wird verwendet</li></ul></div>
<div><div>
<code>
<span class="add">@add(<span class="name">define buffer)</span></span><br/>
<span class="in1"></span>
<span class="type">void</span> <span class="fn">addCharsToBuffer</span>(<br/>
<span class="in2"></span>
<span class="type">struct Buffer *</span><span class="var">buffer</span>,<br/>
<span class="in2"></span>
<span class="type">char</span> <span class="var">ch</span>, <span class="type">int</span> <span class="var">count</span><br/>
<span class="in1"></span>
) {<br/>
<span class="in2"></span>
<span class="fn">ASSERT</span>(<span class="var">buffer</span>);<br/>
<span class="in2"></span>
<span class="fn">ASSERT</span>(<span class="var">count</span> &gt;= 0);<br/>
<span class="in2"></span>
<span class="keyword">for</span> (; <span class="var">count</span>; --<span class="var">count</span>) {<br/>
<span class="in3"></span>
<span class="fn">addToBuffer</span>(<span class="var">buffer</span>, <span class="var">ch</span>);<br/>
<span class="in2"></span>
}<br/>
<span class="in1"></span>
}<br/>

<span class="end">@end(<span class="name">define buffer)</span></span><br/>
</code>
</div>
</div>
<div><div>
<code>
<span class="add">@add(<span class="name">buffer unit tests)</span></span> {<br/>
<span class="in1"></span>
<span class="type">struct Buffer</span> <span class="var">buffer</span> = {};<br/>
<span class="in1"></span>
<span class="fn">addCharsToBuffer</span>(&<span class="var">buffer</span>, <span class="str">'x'</span>,<br/>
<span class="in2"></span>
1000);<br/>
<span class="in1"></span>
<span class="fn">ASSERT</span>(*<span class="var">buffer</span>.<span class="var">buffer</span> == <span class="str">'x'</span>);<br/>
<span class="in1"></span>
<span class="fn">ASSERT</span>(<span class="var">buffer</span>.<span class="var">buffer</span> + 1000 ==<br/>
<span class="in2"></span>
<span class="var">buffer</span>.<span class="var">current</span>);<br/>
<span class="in1"></span>
<span class="fn">ASSERT</span>(<span class="var">buffer</span>.<span class="var">buffer</span> !=<br/>
<span class="in2"></span>
<span class="var">buffer</span>.<span class="var">initial</span>);<br/>
<span class="in1"></span>
<span class="fn">eraseBuffer</span>(&<span class="var">buffer</span>);<br/>
<span class="in1"></span>
<span class="fn">ASSERT</span>(<span class="var">buffer</span>.<span class="var">buffer</span> ==<br/>
<span class="in2"></span>
<span class="var">buffer</span>.<span class="var">initial</span>);<br/>

} <span class="end">@end(<span class="name">buffer unit tests)</span></span><br/>
</code>
</div>
<ul><li>
 Dafür reicht der initiale Buffer nicht aus</li><li>
 Aber der zusätzliche Speicher wird nach dem Löschen freigegeben</li></ul></div>
