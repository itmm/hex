<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Eingabe-Dateien</title>
<link rel="stylesheet" type="text/css" href="slides/slides.css"></head>
<body>
<h1>Eingabe-Dateien</h1>
<div class="slides">
<div><div>
<h1>Eingabe-Dateien</h1>
</div>


</div>
<div><div>
<code>

<span class="macro">@globadd(<span class="name">includes</span>)</span><br/>

<span class="in1"></span>#<span class="var">include</span> &lt;<span class="var">fstream</span>&gt;<br/>

<span class="in1"></span>#<span class="var">include</span> &lt;<span class="var">iostream</span>&gt;<br/>

<span class="in1"></span>#<span class="var">include</span> &lt;<span class="var">memory</span>&gt;<br/>

<span class="in1"></span>#<span class="var">include</span> &lt;<span class="var">vector</span>&gt;<br/>

<span class="macro">@end(<span class="name">includes</span>)</span><br/>

</code>
</div>

<ul><li>
 Aus <code>memory</code> wird <code>unique_ptr</code> verwendet
</li><li>
 <code>vector</code> ist ein Container für Source-Dateien
</li></ul></div>

<div><div>
<code>

<span class="macro">@globadd(<span class="name">global elements</span>)</span><br/>

<span class="in1"></span><span class="var">class</span> <span class="type">Input</span> {<br/>

<span class="in2"></span><span class="var">private</span>:<br/>

<span class="in3"></span><span class="var">std</span>::<span class="var">ifstream</span> <span class="var">file</span>;<br/>

<span class="in3"></span><span class="macro">@expand(<span class="name">private input elements</span>)</span>;<br/>

<span class="in2"></span><span class="var">public</span>:<br/>

<span class="in3"></span><span class="type">const</span> <span class="var">std</span>::<span class="var">string</span> <span class="var">name</span>;<br/>

<span class="in3"></span><span class="macro">@expand(<span class="name">additional input elements</span>)</span>;<br/>

<span class="in3"></span><span class="macro">@expand(<span class="name">input methods</span>)</span>;<br/>

<span class="in1"></span>};<br/>

<span class="macro">@end(<span class="name">global elements</span>)</span><br/>

</code>
</div>

<ul><li>
 Die <code>Input</code>-Klasse enthält den Dateinamen der Eingabe-Dateien
</li><li>
 Zusätzlich kann sie eine offene Datei enthalten
</li><li>
 Alle Eingabe-Dateien, die während einer Inkludierungs-Kaskade
  eingebunden werden bleiben offen, damit an der richtigen Stelle weiter
  gearbeitet werden kann
</li><li>
 Weiter Attribute und Methoden können später definiert werden
</li></ul></div>

<div><div>
<code>

<span class="macro">@def(<span class="name">input methods</span>)</span><br/>

<span class="in1"></span><span class="fn">Input</span>(<br/>

<span class="in2"></span><span class="type">const</span> <span class="var">std</span>::<span class="var">string</span> &amp;<span class="var">name</span><br/>

<span class="in1"></span>):<br/>

<span class="in2"></span><span class="var">file</span> { <span class="var">name</span>.<span class="fn">c_str</span>() },<br/>

<span class="in2"></span><span class="macro">@expand(<span class="name">private input constr</span>)</span><br/>

<span class="in2"></span><span class="var">name</span> { <span class="var">name</span> }<br/>

<span class="in1"></span>{<br/>

<span class="in1"></span>}<br/>

<span class="macro">@end(<span class="name">input methods</span>)</span><br/>

</code>
</div>

<ul><li>
 Im Konstruktor werden Datei und Name gesetzt
</li><li>
 Später eingeführte Attribute können auch dann initialisiert werden
</li></ul></div>

<div><div>
<code>

<span class="macro">@add(<span class="name">input methods</span>)</span><br/>

<span class="in1"></span><span class="type">bool</span> <span class="fn">getLine</span>(<span class="var">std</span>::<span class="var">string</span> &amp;<span class="var">line</span>) {<br/>

<span class="in2"></span><span class="keyword">if</span> (<span class="var">file</span>.<span class="fn">is_open</span>()) {<br/>

<span class="in3"></span><span class="keyword">if</span> (<span class="var">std</span>::<span class="fn">getline</span>(<span class="var">file</span>, <span class="var">line</span>)) {<br/>

<span class="in4"></span><span class="macro">@expand(<span class="name">line read</span>)</span>;<br/>

<span class="in4"></span><span class="keyword">return</span> <span class="num">true</span>;<br/>

<span class="in3"></span>} <span class="keyword">else</span> {<br/>

<span class="in4"></span><span class="var">file</span>.<span class="fn">close</span>();<br/>

<span class="in3"></span>}<br/>

<span class="in2"></span>}<br/>

<span class="in2"></span><span class="keyword">return</span> <span class="num">false</span>;<br/>

<span class="in1"></span>}<br/>

<span class="macro">@end(<span class="name">input methods</span>)</span><br/>

</code>
</div>


</div>
<div><div>
<code>

<span class="macro">@globadd(<span class="name">global elements</span>)</span><br/>

<span class="in1"></span><span class="type">FragMap</span> <span class="var">root</span>;<br/>

<span class="in1"></span><span class="type">FragMap</span> *<span class="var">frags</span> { &amp;<span class="var">root</span> };<br/>

<span class="macro">@end(<span class="name">global elements</span>)</span><br/>

</code>
</div>

<ul><li>
 Kollektion mit allen Fragmenten wird für folgende Schritte sichtbar
  angelegt
</li></ul></div>


<div><div>
<code>

<span class="macro">@globadd(<span class="name">global elements</span>)</span><br/>

<span class="in1"></span><span class="var">class</span> <span class="type">Inputs</span> {<br/>

<span class="in3"></span><span class="macro">@expand(<span class="name">inputs attributes</span>)</span>;<br/>

<span class="in2"></span><span class="var">public</span>:<br/>

<span class="in3"></span><span class="macro">@expand(<span class="name">inputs methods</span>)</span>;<br/>

<span class="in1"></span>};<br/>

<span class="macro">@end(<span class="name">global elements</span>)</span><br/>

</code>
</div>


</div>
<div><div>
<code>

<span class="macro">@def(<span class="name">inputs attributes</span>)</span><br/>

<span class="in1"></span><span class="var">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Input</span>&gt; <span class="var">_input</span>;<br/>

<span class="in1"></span><span class="var">std</span>::<span class="var">vector</span>&lt;<span class="var">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Input</span>&gt;&gt;<br/>

<span class="in2"></span><span class="var">_pending</span>;<br/>

<span class="in1"></span><span class="var">std</span>::<span class="var">vector</span>&lt;<span class="var">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Input</span>&gt;&gt;<br/>

<span class="in2"></span><span class="var">_used</span>;<br/>

<span class="macro">@end(<span class="name">inputs attributes</span>)</span><br/>

</code>
</div>

<ul><li>
 Es gibt immer eine aktuelle Datei, die gerade gelesen wird
</li><li>
 Mitten während des Lesens können andere Dateien eingelesen
  (inkludiert) werden
</li><li>
 Daher gibt es einen Stapel offener Dateien
</li><li>
 Aus der letzten wird aktuell gelesen
</li><li>
 Eine Liste aller gelesenen Dateien wird in <code>used</code> verwaltet
</li><li>
 Damit wird verhindert, dass eine Datei mehrfach gelesen wird
</li><li>
 Auch signalisiert es der HTML-Ausgabe, welche Dateien generiert
  werden müssen
</li></ul></div>

<div><div>
<code>

<span class="macro">@def(<span class="name">inputs methods</span>)</span><br/>

<span class="in1"></span><span class="type">auto</span> &amp;<span class="fn">cur</span>() {<br/>

<span class="in2"></span><span class="keyword">return</span> <span class="var">_input</span>;<br/>

<span class="in1"></span>}<br/>

<span class="macro">@end(<span class="name">inputs methods</span>)</span><br/>

</code>
</div>


</div>
<div><div>
<code>

<span class="macro">@add(<span class="name">inputs methods</span>)</span><br/>

<span class="in1"></span><span class="type">auto</span> <span class="fn">begin</span>() <span class="type">const</span> {<br/>

<span class="in2"></span><span class="keyword">return</span> <span class="var">_used</span>.<span class="fn">cbegin</span>();<br/>

<span class="in1"></span>}<br/>

<span class="macro">@end(<span class="name">inputs methods</span>)</span><br/>

</code>
</div>


</div>
<div><div>
<code>

<span class="macro">@add(<span class="name">inputs methods</span>)</span><br/>

<span class="in1"></span><span class="type">auto</span> <span class="fn">end</span>() <span class="type">const</span> {<br/>

<span class="in2"></span><span class="keyword">return</span> <span class="var">_used</span>.<span class="fn">cend</span>();<br/>

<span class="in1"></span>}<br/>

<span class="macro">@end(<span class="name">inputs methods</span>)</span><br/>

</code>
</div>


</div>
<div><div>
<code>

<span class="macro">@add(<span class="name">inputs methods</span>)</span><br/>

<span class="in1"></span><span class="type">void</span> <span class="fn">push</span>(<span class="type">const</span> <span class="var">std</span>::<span class="var">string</span> &amp;<span class="var">path</span>) {<br/>

<span class="in2"></span><span class="var">std</span>::<span class="var">unique_ptr</span>&lt;<span class="type">Input</span>&gt; <span class="var">i</span> {<br/>

<span class="in3"></span><span class="var">std</span>::<span class="var">make_unique</span>&lt;<span class="type">Input</span>&gt;(<span class="var">path</span>)<br/>

<span class="in2"></span>};<br/>

<span class="in2"></span><span class="macro">@expand(<span class="name">init additional input fields</span>)</span>;<br/>

<span class="in2"></span><span class="macro">@expand(<span class="name">push to pending</span>)</span>;<br/>

<span class="in2"></span><span class="var">_input</span> = <span class="var">std</span>::<span class="fn">move</span>(<span class="var">i</span>);<br/>

<span class="in1"></span>}<br/>

<span class="macro">@end(<span class="name">inputs methods</span>)</span><br/>

</code>
</div>

<ul><li>
 Dateien werden über ihren Pfad identifiziert
</li><li>
 Dieser wird als Name gespeichert
</li><li>
 Durch <code>unique_ptr</code> ist keine direkte Speicherverwaltung notwendig
</li><li>
 Das Verschieben der Ownership muss aber explizit erfolgen
</li></ul></div>

<div><div>
<code>

<span class="macro">@def(<span class="name">push to pending</span>)</span><br/>

<span class="in1"></span><span class="keyword">if</span> (<span class="var">_input</span>) {<br/>

<span class="in2"></span><span class="var">_pending</span>.<span class="fn">push_back</span>(<br/>

<span class="in3"></span><span class="var">std</span>::<span class="fn">move</span>(<span class="var">_input</span>)<br/>

<span class="in2"></span>);<br/>

<span class="in1"></span>}<br/>

<span class="macro">@end(<span class="name">push to pending</span>)</span><br/>

</code>
</div>

<ul><li>
 Falls schon eine Datei offen ist, wird sie nach <code>pending</code> verschoben
</li></ul></div>

</div>
<h1>Nächstes Zeichen</h1>
<div class="slides">
<div><div>
<h1>Nächstes Zeichen</h1>
</div>

<ul><li>
 Die Funktion <code>get</code> liest das nächste Zeichen aus der aktuellen
  Datei
</li><li>
 Wenn das Dateiende erreicht ist, wird die nächste Datei aus dem
  Stapel der offenen Dateien geholt
</li><li>
 Erst wenn die letzte Datei fertig gelesen wurde, wird ein <code>EOF</code>
  zurück geliefert
</li></ul></div>

<div><div>
<code>

<span class="macro">@add(<span class="name">inputs methods</span>)</span><br/>

<span class="in1"></span><span class="type">bool</span> <span class="fn">getLine</span>(<span class="var">std</span>::<span class="var">string</span> &amp;<span class="var">line</span>) {<br/>

<span class="in2"></span><span class="keyword">while</span> (<span class="var">_input</span>) {<br/>

<span class="in3"></span><span class="keyword">if</span> (<span class="var">_input</span>-&gt;<span class="fn">getLine</span>(<span class="var">line</span>)) {<br/>

<span class="in4"></span><span class="keyword">return</span> <span class="num">true</span>;<br/>

<span class="in3"></span>}<br/>

<span class="in3"></span><span class="macro">@expand(<span class="name">get next input file</span>)</span>;<br/>

<span class="in2"></span>}<br/>

<span class="in2"></span><span class="keyword">return</span> <span class="num">false</span>;<br/>

<span class="in1"></span>}<br/>

<span class="macro">@end(<span class="name">inputs methods</span>)</span><br/>

</code>
</div>


</div>
<div><div>
<code>

<span class="macro">@def(<span class="name">get next input file</span>)</span><br/>

<span class="in1"></span><span class="var">_used</span>.<span class="fn">push_back</span>(<span class="var">std</span>::<span class="fn">move</span>(<span class="var">_input</span>));<br/>

<span class="in1"></span><span class="keyword">if</span> (! <span class="var">_pending</span>.<span class="fn">empty</span>()) {<br/>

<span class="in2"></span><span class="var">_input</span> = <span class="var">std</span>::<span class="fn">move</span>(<span class="var">_pending</span>.<span class="fn">back</span>());<br/>

<span class="in2"></span><span class="var">_pending</span>.<span class="fn">pop_back</span>();<br/>

<span class="in1"></span>}<br/>

<span class="in1"></span><span class="var">frags</span> = <span class="var">frags</span>-&gt;<span class="fn">setLink</span>(<span class="num">nullptr</span>);<br/>

<span class="macro">@end(<span class="name">get next input file</span>)</span><br/>

</code>
</div>

<ul><li>
 Die aktuelle Datei wird geschlossen und in die Liste der bereits
  verarbeiteten Dateien eingereiht
</li><li>
 Dann wird der Vorgänger zur aktuellen Datei erklärt
</li><li>
 Der Vorgänger wird aus dem globalen Namensraum wieder entfernt
</li></ul></div>

<div><div>
<code>

<span class="macro">@add(<span class="name">inputs methods</span>)</span><br/>

<span class="in1"></span><span class="type">bool</span> <span class="fn">has</span>(<span class="type">const</span> <span class="var">std</span>::<span class="var">string</span> &amp;<span class="var">name</span>) <span class="type">const</span> {<br/>

<span class="in2"></span><span class="keyword">if</span> (<span class="var">_input</span> &amp;&amp; <span class="var">_input</span>-&gt;<span class="var">name</span> == <span class="var">name</span>) {<br/>

<span class="in3"></span><span class="keyword">return</span> <span class="num">true</span>;<br/>

<span class="in2"></span>}<br/>

<span class="in2"></span><span class="keyword">for</span> (<span class="type">const</span> <span class="type">auto</span> &amp;<span class="var">j</span> : <span class="var">_pending</span>) {<br/>

<span class="in3"></span><span class="keyword">if</span> (<span class="var">j</span>-&gt;<span class="var">name</span> == <span class="var">name</span>) {<br/>

<span class="in4"></span><span class="keyword">return</span> <span class="num">true</span>;<br/>

<span class="in3"></span>}<br/>

<span class="in2"></span>}<br/>

<span class="in2"></span><span class="keyword">for</span> (<span class="type">const</span> <span class="type">auto</span> &amp;<span class="var">j</span> : <span class="var">_used</span>) {<br/>

<span class="in3"></span><span class="keyword">if</span> (<span class="var">j</span>-&gt;<span class="var">name</span> == <span class="var">name</span>) {<br/>

<span class="in4"></span><span class="keyword">return</span> <span class="num">true</span>;<br/>

<span class="in3"></span>}<br/>

<span class="in2"></span>}<br/>

<span class="in2"></span><span class="keyword">return</span> <span class="num">false</span>;<br/>

<span class="in1"></span>}<br/>

<span class="macro">@end(<span class="name">inputs methods</span>)</span><br/>

</code>
</div>

<ul><li>
 Prüft ob eine Datei bereits verwendet wurde
</li><li>
 Sowohl die offenen als auch die bereits prozessierten Dateien werden
  durchgegangen
</li><li>
 Dadurch wird bei Einbettungen verhindert, dass eine Datei mehrfach
  verarbeitet wird
</li></ul></div>

</div>
<h1>Lokale Fragmente</h1>
<div class="slides">
<div><div>
<h1>Lokale Fragmente</h1>
</div>


</div>
<div><div>
<code>

<span class="macro">@def(<span class="name">additional input elements</span>)</span><br/>

<span class="in1"></span><span class="type">FragMap</span> <span class="var">frags</span>;<br/>

<span class="macro">@end(<span class="name">additional input elements</span>)</span><br/>

</code>
</div>

<ul><li>
 Jede Source-Datei hat eine eigene Fragment-Map mit lokalen
  Definitionen
</li></ul></div>

<div><div>
<code>

<span class="macro">@def(<span class="name">init additional input fields</span>)</span><br/>

<span class="in1"></span><span class="keyword">if</span> (<span class="var">_input</span>) {<br/>

<span class="in2"></span><span class="var">_input</span>-&gt;<span class="var">frags</span>.<span class="fn">setLink</span>(<span class="var">frags</span>);<br/>

<span class="in2"></span><span class="var">frags</span> = &amp;<span class="var">_input</span>-&gt;<span class="var">frags</span>;<br/>

<span class="in1"></span>}<br/>

<span class="macro">@end(<span class="name">init additional input fields</span>)</span><br/>

</code>
</div>

<ul><li>
 Wenn es bereits eine offene Input-Datei gibt, dann wird deren lokale
  Fragmente in den globalen Namensraum aufgenommen
</li></ul></div>

</div>
<h1>Zeilennummern</h1>
<div class="slides">
<div><div>
<h1>Zeilennummern</h1>
</div>


</div>
<div><div>
<code>

<span class="macro">@def(<span class="name">private input elements</span>)</span><br/>

<span class="in1"></span><span class="type">int</span> <span class="var">_line</span>;<br/>

<span class="macro">@end(<span class="name">private input elements</span>)</span><br/>

</code>
</div>

<ul><li>
 Pro Datei wird die aktuelle Zeile festgehalten
</li><li>
 <code>_shouldAdd</code> signalisiert, dass das nächse Zeichen in einer neuen Zeile
  ist
</li></ul></div>

<div><div>
<code>

<span class="macro">@def(<span class="name">private input constr</span>)</span><br/>

<span class="in1"></span><span class="var">_line</span> { <span class="num">0</span> },<br/>

<span class="macro">@end(<span class="name">private input constr</span>)</span><br/>

</code>
</div>


</div>
<div><div>
<code>

<span class="macro">@add(<span class="name">input methods</span>)</span><br/>

<span class="in1"></span><span class="type">int</span> <span class="fn">line</span>() <span class="type">const</span> {<br/>

<span class="in2"></span><span class="keyword">return</span> <span class="var">_line</span>;<br/>

<span class="in1"></span>}<br/>

<span class="macro">@end(<span class="name">input methods</span>)</span><br/>

</code>
</div>


</div>
<div><div>
<code>

<span class="macro">@def(<span class="name">line read</span>)</span><br/>

<span class="in1"></span>++<span class="var">_line</span>;<br/>

<span class="macro">@end(<span class="name">line read</span>)</span><br/>

</code>
</div>


